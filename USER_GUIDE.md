# Frigate Event Buffer User Guide (Unraid + Dockge)

This guide explains how to set up and use the **Frigate Event Buffer** on an Unraid server managed with **Dockge**. It assumes you already have Frigate NVR running and are familiar with basic Unraid operations.

## 1. What the Project Does

Frigate Event Buffer is a state-aware orchestrator designed to enhance Frigate NVR (specifically version 0.17+ with GenAI support). It acts as a middleware between Frigate and Home Assistant, providing:

-   **Smart Notifications**: Sends progressive notifications to Home Assistant (New -> Described -> Finalized) as event details emerge.
-   **Evidence Locker**: Maintains a rolling buffer of event clips and snapshots (default 3 days) independent of Frigate's retention.
-   **GenAI Integration**: Captures and displays AI-generated titles, descriptions, and threat levels from Frigate.
-   **Event Viewer**: A dedicated web interface (`/player`) to review events, watch clips, and manage reviews.
-   **Daily Summaries**: Fetches and displays daily security reports generated by Frigate's review summary API.

## 2. Unraid + Dockge Setup

To run this project on Unraid using Dockge, you will create a new stack that builds the application directly from its GitHub repository. This ensures you have the latest version without needing to manually clone files to your server.

### Prerequisites
-   **Unraid Server**: With Docker enabled.
-   **Dockge**: Installed and running on Unraid.
-   **Frigate NVR**: Running and accessible (you'll need its URL).
-   **MQTT Broker**: Running and accessible (e.g., Mosquitto).

### Steps
1.  Open your **Dockge** dashboard.
2.  Click **+ Compose** to create a new stack.
3.  Name the stack `frigate-buffer`.
4.  In the editor, you will paste the Docker Compose configuration (see Section 3 below).
5.  **Important**: Since there is no pre-built Docker image on Docker Hub, we use the `build` directive to pull the code from GitHub and build the image locally on your Unraid server.

### Unraid Paths
We will use the standard Unraid appdata location:
-   **Config & Storage**: `/mnt/user/appdata/frigate_buffer`

You should create this folder on your Unraid server before starting (e.g., using the terminal or File Manager):
```bash
mkdir -p /mnt/user/appdata/frigate_buffer
```

## 3. Docker Compose

Copy the following YAML into your Dockge stack editor. **You must customize the environment variables** to match your network.

```yaml
version: '3.8'

services:
  frigate-buffer:
    container_name: frigate_buffer
    restart: unless-stopped

    # Build from the public GitHub repository
    build:
      context: https://github.com/jballard86/frigate-event-buffer.git#main

    ports:
      # Web Interface: http://UNRAID_IP:5055
      - "5055:5055"

    volumes:
      # Storage for clips, snapshots, and database
      - /mnt/user/appdata/frigate_buffer:/app/storage

      # (Optional) Configuration file
      - /mnt/user/appdata/frigate_buffer/config.yaml:/app/config.yaml:ro

      # Localtime for correct timestamps in logs
      - /etc/localtime:/etc/localtime:ro

    environment:
      # --- REQUIRED NETWORK SETTINGS ---

      # IP/Hostname of THIS container (used in notification URLs)
      # Must be reachable by your phone/Home Assistant
      - BUFFER_IP=YOUR_UNRAID_IP

      # Frigate URL (internal IP is best)
      - FRIGATE_URL=http://YOUR_FRIGATE_IP:5000

      # MQTT Broker IP
      - MQTT_BROKER=YOUR_MQTT_BROKER_IP

      # --- OPTIONAL SETTINGS (can also be in config.yaml) ---
      - MQTT_PORT=1883
      - RETENTION_DAYS=3
      - LOG_LEVEL=INFO
```

### Key Changes Required:
-   `BUFFER_IP`: Replace `YOUR_UNRAID_IP` with the actual IP address of your Unraid server (e.g., `192.168.1.10`). Do not use `localhost`.
-   `FRIGATE_URL`: Replace `YOUR_FRIGATE_IP` with the IP of your Frigate instance.
-   `MQTT_BROKER`: Replace `YOUR_MQTT_BROKER_IP` with the IP of your MQTT broker.

## 4. Configuration

While environment variables handle the basics, a `config.yaml` file allows for advanced filtering (cameras, labels, zones).

**Location**: Create a file named `config.yaml` inside `/mnt/user/appdata/frigate_buffer/`.

### Minimal `config.yaml` Example
If you don't create this file, the app will try to process all events, but **camera filtering is highly recommended** to reduce noise.

```yaml
# /mnt/user/appdata/frigate_buffer/config.yaml

cameras:
  # Doorbell: Only notify for people and packages
  - name: "Doorbell"
    labels:
      - "person"
      - "package"

  # Driveway: Only vehicles
  - name: "Driveway"
    labels:
      - "car"
      - "truck"
    # Optional: Ignore events that stay in the 'road' zone
    event_filters:
      zones_to_ignore:
        - "road"
      exceptions:
        - "person"  # Always notify for people, even in road

settings:
  retention_days: 3
  cleanup_interval_hours: 1
  log_level: "INFO"
```

**Note**: The app automatically looks for `/app/storage/config.yaml`. Since we mounted `/mnt/user/appdata/frigate_buffer` to `/app/storage`, placing the file there works automatically. The compose file above also explicitly mounts it to `/app/config.yaml` as a backup.

## 5. Environment Variables

The application respects the following environment variables. These take precedence over `config.yaml`.

| Variable | Required | Default | Description |
| :--- | :--- | :--- | :--- |
| `BUFFER_IP` | **Yes** | - | IP where this service is reachable (for notification links). |
| `FRIGATE_URL` | **Yes** | - | Base URL of your Frigate instance. |
| `MQTT_BROKER` | **Yes** | - | MQTT Broker IP address. |
| `MQTT_PORT` | No | `1883` | MQTT Broker port. |
| `RETENTION_DAYS` | No | `3` | Days to keep event clips/snapshots. |
| `LOG_LEVEL` | No | `INFO` | Logging verbosity (`DEBUG`, `INFO`, `WARNING`, `ERROR`). |
| `STATS_REFRESH_SECONDS` | No | `60` | Auto-refresh interval for the Stats page. |
| `HA_URL` | No | - | Home Assistant API URL (for stats cost tracking). |
| `HA_TOKEN` | No | - | Long-lived access token for HA. |

## 6. Post-Setup: Verifying and Using the App

Once the container is running in Dockge:

1.  **Check Status**:
    Open a browser and go to: `http://YOUR_UNRAID_IP:5055/status`
    You should see a JSON response with `"online": true` and `"mqtt_connected": true`.

2.  **Web Interface (Player)**:
    Access the main UI at: `http://YOUR_UNRAID_IP:5055/player`
    -   **Events**: View recent events, filter by camera, or mark as reviewed.
    -   **Daily Review**: Click "Daily Review" to see AI summaries.
    -   **Stats**: Click "Stats" for storage usage and event counts.

3.  **Home Assistant Integration**:
    The app sends notifications to the MQTT topic `frigate/custom/notifications`.
    -   **Android/iOS Notifications**: You need an automation in Home Assistant to listen to this topic and send notifications to your phone. (See repository `README.md` for an example automation).
    -   **Dashboard**: You can embed the player using an **iframe card**:
        ```yaml
        type: iframe
        url: "http://YOUR_UNRAID_IP:5055/player"
        aspect_ratio: "16:9"
        ```

## 7. Troubleshooting

-   **MQTT Not Connecting**:
    -   Check the container logs in Dockge.
    -   Verify `MQTT_BROKER` IP is correct.
    -   Ensure no firewall is blocking port 1883.

-   **"Frigate URL not configured"**:
    -   Ensure `FRIGATE_URL` is set in environment variables or `config.yaml`.
    -   It must include the protocol (e.g., `http://`).

-   **Clips Not Downloading**:
    -   The app relies on Frigate's Export API. Ensure Frigate is running and accessible from the buffer container.
    -   Check logs for "Export API failed".

-   **Wrong Paths**:
    -   If config is not found, ensure it is named exactly `config.yaml` and is in `/mnt/user/appdata/frigate_buffer/`.
