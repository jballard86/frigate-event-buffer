{% extends "base.html" %}

{% block title %}Daily Report - Frigate Event Buffer{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<!-- Top Bar -->
<div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-white flex items-center gap-3">
    <svg class="w-7 h-7 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
    Daily Report
  </h1>
</div>

<!-- Controls Toolbar -->
<div class="bg-cardbg border border-cardborder rounded-xl p-4 mb-6 shadow-lg">
  <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center">
    <!-- Date Selector -->
    <div class="flex items-center gap-3">
      <label for="dateSelect" class="text-gray-400 text-sm font-medium whitespace-nowrap">Select date:</label>
      <select id="dateSelect" class="bg-gray-800 border border-gray-700 text-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-brand focus:border-transparent min-w-[200px]">
        <option value="">Loading...</option>
      </select>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap gap-2">
      <button id="btnLoad" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-brand/20 text-brand border border-brand/30 hover:bg-brand/30 transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L5 8m4-4v12"></path></svg>
        Load Report
      </button>
      <button id="btnCurrentDay" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-green-900/50 text-green-400 border border-green-700/50 hover:bg-green-900/70 transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
        Today's Report
      </button>
      <button id="btnGenerate" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-blue-900/50 text-blue-400 border border-blue-700/50 hover:bg-blue-900/70 transition-all">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
        Generate Today's Report
      </button>
    </div>
  </div>
</div>

<!-- Error Message -->
<div id="errorMsg" class="hidden mb-6 p-4 bg-red-900/30 border border-red-700/50 rounded-lg text-red-400">
  <div class="flex items-center gap-2">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    <span id="errorText"></span>
  </div>
</div>

<!-- Loading State -->
<div id="loading" class="hidden flex items-center justify-center py-20">
  <div class="animate-pulse flex items-center gap-3 text-gray-500">
    <svg class="w-6 h-6 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
    <span class="text-lg" id="loadingText">Loading report...</span>
  </div>
</div>

<!-- Report Content -->
<div id="reviewContent" class="bg-cardbg border border-cardborder rounded-xl p-6 shadow-lg text-gray-200">
  <div class="text-center py-20 text-gray-500">
    <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
    <p class="text-lg">Select a date and click "Load Report" to view a daily report.</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  'use strict';

  const dateSelect = document.getElementById('dateSelect');
  const btnLoad = document.getElementById('btnLoad');
  const btnCurrentDay = document.getElementById('btnCurrentDay');
  const btnGenerate = document.getElementById('btnGenerate');
  const errorMsg = document.getElementById('errorMsg');
  const errorText = document.getElementById('errorText');
  const loading = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');
  const reviewContent = document.getElementById('reviewContent');
  let hasLoadedReportOnce = false;

  function hideError() {
    errorMsg.classList.add('hidden');
  }

  function showError(msg) {
    errorText.textContent = msg;
    errorMsg.classList.remove('hidden');
  }

  function setLoading(on, text) {
    if (on) {
      loading.classList.remove('hidden');
      reviewContent.classList.add('hidden');
      if (text) loadingText.textContent = text;
    } else {
      loading.classList.add('hidden');
      reviewContent.classList.remove('hidden');
    }
  }

  function showRefreshToast() {
    let toast = document.getElementById('dailyReviewRefreshToast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'dailyReviewRefreshToast';
      toast.className = 'fixed bottom-4 right-4 z-50 px-4 py-2 rounded-lg bg-amber-900/90 text-amber-200 text-sm border border-amber-700/50 shadow-lg';
      document.body.appendChild(toast);
    }
    toast.textContent = 'Could not load report. Showing previous content.';
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 4000);
  }

  function formatDateLabel(d) {
    const date = new Date(d + 'T12:00:00');
    return date.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
  }

  async function loadDates() {
    try {
      const resp = await fetch('/api/daily-review/dates');
      const data = await resp.json();
      const dates = data.dates || [];

      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toISOString().slice(0, 10);

      const today = new Date();
      const todayStr = today.toISOString().slice(0, 10);

      const allDates = new Set(dates);
      if (!allDates.has(yesterdayStr)) allDates.add(yesterdayStr);
      if (!allDates.has(todayStr)) allDates.add(todayStr);

      const sorted = Array.from(allDates).sort().reverse();

      dateSelect.innerHTML = '';
      sorted.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = formatDateLabel(d) + (d === todayStr ? ' (today)' : '');
        dateSelect.appendChild(opt);
      });

      dateSelect.value = yesterdayStr;
      return yesterdayStr;
    } catch (e) {
      console.error('Failed to load dates:', e);
      showError('Failed to load dates.');
      dateSelect.innerHTML = '<option value="">Error</option>';
      return null;
    }
  }

  async function loadReview(dateStr, showLoading = true) {
    if (!dateStr) {
      showError('Please select a date.');
      return;
    }
    hideError();
    if (showLoading) setLoading(true, 'Loading report...');
    try {
      const resp = await fetch(`/api/daily-review/${dateStr}`);
      const data = await resp.json();
      if (!resp.ok) {
        throw new Error(data.error || 'Failed to load report');
      }
      renderReview(data);
      hasLoadedReportOnce = true;
    } catch (e) {
      if (hasLoadedReportOnce) {
        showRefreshToast();
      } else {
        showError(e.message || 'Failed to load report.');
        reviewContent.innerHTML = '';
      }
    } finally {
      setLoading(false);
    }
  }

  async function fetchCurrentDay() {
    hideError();
    setLoading(true, 'Loading report...');
    try {
      const resp = await fetch('/api/daily-review/current');
      const data = await resp.json();
      if (!resp.ok) {
        throw new Error(data.error || 'No report for today yet');
      }
      renderReview(data);
      hasLoadedReportOnce = true;
      await loadDates();
      const today = new Date().toISOString().slice(0, 10);
      dateSelect.value = today;
    } catch (e) {
      showError(e.message || 'No report for today yet.');
      reviewContent.innerHTML = '';
    } finally {
      setLoading(false);
    }
  }

  async function generateTodayReport() {
    hideError();
    setLoading(true, 'Generating report...');
    try {
      const resp = await fetch('/api/daily-review/generate', { method: 'POST' });
      const data = await resp.json();
      if (!resp.ok) {
        throw new Error(data.error || 'Generation failed');
      }
      await loadDates();
      const today = new Date().toISOString().slice(0, 10);
      dateSelect.value = today;
      await loadReview(today, true);
    } catch (e) {
      showError(e.message || 'Failed to generate report.');
    } finally {
      setLoading(false);
    }
  }

  function renderReview(data) {
    const summary = data.summary || '';
    let html = '';
    if (typeof marked !== 'undefined') {
      const rawHtml = marked.parse(summary);
      html = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(rawHtml) : rawHtml;
    } else {
      html = summary.replace(/\n/g, '<br>').replace(/^# (.*)$/gm, '<h1>$1</h1>')
        .replace(/^## (.*)$/gm, '<h2>$1</h2>').replace(/^### (.*)$/gm, '<h3>$1</h3>');
    }
    // Apply Tailwind Typography with dark theme to match rest of app
    reviewContent.innerHTML = '<div class="prose prose-invert prose-lg max-w-none prose-headings:text-brand prose-p:text-gray-300 prose-li:text-gray-300 prose-strong:text-white prose-a:text-brand prose-blockquote:border-brand/50 prose-blockquote:bg-gray-800/50 prose-pre:bg-gray-900 prose-code:text-gray-300">' + html + '</div>';
  }

  btnLoad.addEventListener('click', () => loadReview(dateSelect.value));
  btnCurrentDay.addEventListener('click', fetchCurrentDay);
  btnGenerate.addEventListener('click', generateTodayReport);
  dateSelect.addEventListener('change', () => loadReview(dateSelect.value));

  loadDates().then((defaultDate) => {
    const sel = dateSelect.value || defaultDate;
    if (sel) loadReview(sel, false);
  }).catch(() => setLoading(false));
})();
</script>
{% endblock %}
