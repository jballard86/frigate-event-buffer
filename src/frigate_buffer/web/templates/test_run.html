<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test multi-cam pipeline</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e0e0e0; min-height: 100vh; padding: 16px; }
  .header { background: #16213e; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #0f3460; }
  .header h1 { font-size: 1.1rem; color: #e94560; }
  .log-area { background: #0f3460; border: 1px solid #533483; border-radius: 8px; padding: 12px; min-height: 200px; max-height: 60vh; overflow-y: auto; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; word-break: break-all; }
  .log-area .err { color: #ff6b6b; }
  .log-area .done { color: #7dde7d; margin-top: 12px; }
  .link-box { margin-top: 16px; padding: 12px; background: #16213e; border-radius: 8px; border: 1px solid #0f3460; }
  .link-box a { color: #e94560; }
  .link-box p { margin: 8px 0; }
  .no-subdir { color: #888; }
  .btn-row { margin: 12px 0; display: flex; gap: 12px; flex-wrap: wrap; }
  .btn-row button { padding: 8px 16px; background: #0f3460; border: 1px solid #533483; border-radius: 6px; color: #e0e0e0; cursor: pointer; font-size: 0.9rem; }
  .btn-row button:hover:not(:disabled) { background: #16213e; }
  .btn-row button:disabled { opacity: 0.6; cursor: not-allowed; }
</style>
</head>
<body>
  <div class="header">
    <h1>Test multi-cam pipeline</h1>
    <p class="no-subdir" id="headerText">{% if subdir %}Event: <strong>{{ subdir }}</strong>{% else %}Open this page from the player TEST button (select a consolidated event with clips ready).{% endif %}</p>
  </div>
  <div id="btnRow" class="btn-row" style="display: none;">
    <button type="button" id="btnStartTest">Start the test</button>
    <button type="button" id="btnVideoRequest">Video request</button>
  </div>
  <div id="logContainer">
    <div class="log-area" id="logArea">{% if subdir %}Copying...{% else %}No event selected. Use the TEST button on the player for a consolidated event.{% endif %}</div>
    <div class="link-box" id="linkBox" style="display: none;">
      <p><strong>Done.</strong></p>
      <p><a id="aiRequestLink" href="" target="_blank" rel="noopener noreferrer">View AI request (frames and prompt)</a></p>
    </div>
  </div>
<script type="application/json" id="test-run-subdir">{{ subdir|tojson }}</script>
<script>
(function() {
  const eventSubdir = JSON.parse(document.getElementById('test-run-subdir').textContent);
  const logArea = document.getElementById('logArea');
  const linkBox = document.getElementById('linkBox');
  const aiRequestLink = document.getElementById('aiRequestLink');
  const btnRow = document.getElementById('btnRow');
  const btnStartTest = document.getElementById('btnStartTest');
  const btnVideoRequest = document.getElementById('btnVideoRequest');
  const headerText = document.getElementById('headerText');

  function appendLog(msg, isError) {
    const el = isError ? document.createElement('span') : document.createTextNode(msg + '\n');
    if (isError) { el.className = 'err'; el.textContent = msg + '\n'; }
    logArea.appendChild(el);
    logArea.scrollTop = logArea.scrollHeight;
  }

  function setButtonsEnabled(enabled) {
    btnStartTest.disabled = !enabled;
    btnVideoRequest.disabled = !enabled;
  }

  function connectStream(url, onDone) {
    setButtonsEnabled(false);
    const es = new EventSource(url);
    es.onmessage = function(e) {
      try {
        const ev = JSON.parse(e.data);
        if (ev.type === 'log') {
          appendLog(ev.message, false);
        } else if (ev.type === 'done') {
          appendLog('Done.', false);
          if (ev.ai_request_url) {
            aiRequestLink.href = ev.ai_request_url;
            aiRequestLink.textContent = 'View AI request (frames and prompt)';
            linkBox.style.display = 'block';
          }
          es.close();
          setButtonsEnabled(true);
          if (onDone) onDone();
        } else if (ev.type === 'error') {
          appendLog('Error: ' + (ev.message || 'Unknown'), true);
          es.close();
          setButtonsEnabled(true);
          if (onDone) onDone();
        }
      } catch (err) {
        appendLog('Parse error: ' + err.message, true);
        es.close();
        setButtonsEnabled(true);
      }
    };
    es.onerror = function() {
      if (linkBox.style.display !== 'block') appendLog('Connection error or stream ended.', true);
      es.close();
      setButtonsEnabled(true);
    };
  }

  if (!eventSubdir) return;

  logArea.textContent = 'Copying...\n';
  fetch('/api/test-multi-cam/prepare?subdir=' + encodeURIComponent(eventSubdir))
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.error) {
        logArea.textContent = 'Error: ' + data.error + '\n';
        return;
      }
      const testRunId = data.test_run_id;
      logArea.textContent = 'Event: ' + eventSubdir + '\nTest run: ' + testRunId + '\n';
      if (headerText) headerText.innerHTML = 'Event: <strong>' + eventSubdir + '</strong> &middot; Test run: <strong>' + testRunId + '</strong>';
      btnRow.style.display = 'flex';
      btnStartTest.onclick = function() {
        appendLog('Starting test pipeline...', false);
        connectStream('/api/test-multi-cam/stream?test_run=' + encodeURIComponent(testRunId));
      };
      btnVideoRequest.onclick = function() {
        appendLog('Video request (Frigate Export API)...', false);
        connectStream('/api/test-multi-cam/video-request?test_run=' + encodeURIComponent(testRunId));
      };
    })
    .catch(function(e) {
      logArea.textContent = 'Error: ' + e.message + '\n';
    });
})();
</script>
</body>
</html>
