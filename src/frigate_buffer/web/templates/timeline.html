{% extends "base.html" %}

{% block title %}Notification Timeline - {{ event_id }}{% endblock %}

{% block content %}
<!-- Top Bar -->
<div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-white flex items-center gap-3">
    <svg class="w-7 h-7 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    Notification Timeline
  </h1>
  <div class="flex flex-wrap gap-2">
    <a href="/player?camera={{ camera }}&subdir={{ subdir }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-gray-800 text-gray-300 border border-gray-700 hover:bg-gray-700 transition-all">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
      Back to Player
    </a>
    <a href="/events/{{ camera }}/{{ subdir }}/timeline/download" download="notification_timeline.json" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-green-900/50 text-green-400 border border-green-700/50 hover:bg-green-900/70 transition-all">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
      Download Timeline
    </a>
    {% if has_ai_analysis_zip and first_ai_analysis_zip_path %}
    <a href="/files/{{ camera }}/{{ subdir }}/{{ first_ai_analysis_zip_path }}" download="{{ first_ai_analysis_zip_path | replace('/', '_') }}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium bg-purple-900/50 text-purple-400 border border-purple-700/50 hover:bg-purple-900/70 transition-all">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
      Download AI Analysis
    </a>
    {% endif %}
  </div>
</div>

<!-- Event Info Card -->
<div class="bg-cardbg border border-cardborder rounded-xl p-5 mb-6 shadow-lg">
  <div class="flex flex-col md:flex-row md:items-center gap-4 mb-3">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-brand/20 flex items-center justify-center">
        <svg class="w-5 h-5 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
      </div>
      <div>
        <div class="text-sm text-gray-400">Event ID</div>
        <div class="text-white font-mono text-sm">{{ event_id }}</div>
      </div>
    </div>
    <div class="h-px md:h-8 w-full md:w-px bg-gray-700"></div>
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center">
        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
      </div>
      <div>
        <div class="text-sm text-gray-400">Camera</div>
        <div class="text-white">{{ camera }}</div>
      </div>
    </div>
  </div>
  <p class="text-gray-400 text-sm">
    Data received from Frigate, sent to Frigate API, responses, and notifications (e.g. Home Assistant).
    {% if export_duration_seconds is not none and export_file_list %}
    <br>
    <span class="text-brand">Export took {{ "%.1f"|format(export_duration_seconds) }}s.</span> Files: {{ export_file_list | join(", ") }}.
    {% endif %}
  </p>
</div>

<!-- Timeline Entries -->
<div class="space-y-4">
  {% if entries %}
  {% for e in entries %}
  {% set source = e.get('source', 'unknown') %}
  {% set direction = e.get('direction', '') %}
  {% set label = e.get('label', '') %}
  
  {% set source_colors = {
    'frigate_mqtt': 'bg-green-900/50 text-green-400 border-green-700/50',
    'frigate_api': 'bg-amber-900/50 text-amber-400 border-amber-700/50',
    'ha_notification': 'bg-purple-900/50 text-purple-400 border-purple-700/50',
    'notification_dispatch': 'bg-blue-900/50 text-blue-400 border-blue-700/50',
    'test_ai_prompt': 'bg-pink-900/50 text-pink-400 border-pink-700/50'
  } %}
  
  {% set direction_colors = {
    'in': 'bg-gray-700 text-gray-300',
    'out': 'bg-green-900/50 text-green-400'
  } %}

  <div class="bg-cardbg border border-cardborder rounded-xl p-5 shadow-lg hover:border-gray-600 transition-colors">
    <!-- Entry Header -->
    <div class="flex flex-wrap items-center gap-3 mb-4">
      <!-- Timestamp -->
      <div class="flex items-center gap-2 text-gray-400 font-mono text-sm">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        {{ e.get('ts', '') }}
      </div>
      
      <!-- Source Badge -->
      <span class="px-2 py-1 rounded-md text-xs font-semibold border {{ source_colors.get(source, 'bg-gray-800 text-gray-400 border-gray-700') }}">
        {{ source }}
      </span>
      
      <!-- Direction Badge -->
      {% if direction %}
      <span class="px-2 py-1 rounded-md text-xs font-semibold {{ direction_colors.get(direction, 'bg-gray-800 text-gray-400') }}">
        {{ direction }}
      </span>
      {% endif %}
      
      <!-- Label -->
      {% if label %}
      <span class="text-brand font-medium text-sm">{{ label }}</span>
      {% endif %}
    </div>
    
    <!-- Entry Data -->
    <div class="bg-gray-900 rounded-lg p-4 overflow-x-auto">
      <pre class="text-sm text-gray-300 font-mono whitespace-pre-wrap break-words max-h-96 overflow-y-auto">{{ (e.get('data') or {}) | tojson(indent=2) }}</pre>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="text-center py-20">
    <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    <h2 class="text-xl text-gray-400 mb-2">No timeline data yet</h2>
    <p class="text-gray-500">Data will appear as the event is processed.</p>
  </div>
  {% endif %}
</div>

<!-- Event Files Section -->
{% if event_files %}
<div class="mt-8 bg-cardbg border border-cardborder rounded-xl p-5 shadow-lg">
  <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
    <svg class="w-5 h-5 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
    Event Files
  </h2>
  <ul class="space-y-2">
    {% for f in event_files %}
    <li class="flex items-center gap-3 p-3 bg-gray-800/30 rounded-lg hover:bg-gray-800/50 transition-colors">
      <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
      <a href="/files/{{ camera }}/{{ subdir }}/{{ f }}" download="{{ f }}" class="text-blue-400 hover:text-blue-300 transition-colors font-mono text-sm">{{ f }}</a>
    </li>
    {% endfor %}
  </ul>
</div>
{% endif %}
{% endblock %}
