{% extends "base.html" %}

{% block title %}Frigate Event Viewer{% endblock %}

{% block content %}
<!-- Flash Notification -->
<div id="flash" class="fixed top-4 right-4 z-50 bg-green-600 text-white px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300 pointer-events-none shadow-lg text-sm font-medium"></div>

<!-- Main Content Area -->
<div id="mainContent">
  <div class="flex items-center justify-center py-20">
    <div class="animate-pulse flex items-center gap-3 text-gray-500">
      <svg class="w-6 h-6 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
      <span class="text-lg">Loading events...</span>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  'use strict';

  let events = [];
  let currentIndex = 0;
  let refreshTimer = null;
  let videoPlaying = false;
  let lastRenderedEventId = null;
  let currentFilter = 'unreviewed';
  let hasLoadedOnce = false;
  let lastShowTestEvents = null;
  let filterFetchInProgress = false;

  const mainContent = document.getElementById('mainContent');
  const flashEl = document.getElementById('flash');
  const btnTestEvents = document.getElementById('btnTestEvents');

  // Filter buttons: delegated from sidebar (buttons are injected in render())
  const sidebarPlayerExtras = document.getElementById('sidebarPlayerExtras');
  if (sidebarPlayerExtras) {
    sidebarPlayerExtras.addEventListener('click', (e) => {
      const btn = e.target.closest('.filter-btn');
      if (!btn) return;
      if (filterFetchInProgress) return;
      currentFilter = btn.dataset.filter;
      updateFilterButtons();
      filterFetchInProgress = true;
      fetchEvents().finally(() => { filterFetchInProgress = false; });
      startAutoRefresh();
    });
  }

  function getFilterButtonClass(filter) {
    const active = 'bg-brand/20 text-brand border-brand/30 hover:bg-brand/30';
    const inactive = 'bg-gray-800 text-gray-300 border border-gray-700 hover:bg-gray-700';
    return currentFilter === filter ? active : inactive;
  }

  function buildSidebarFilterButtonsHtml(showTestEvents) {
    const btnClass = 'filter-btn px-3 py-2 rounded-lg text-sm font-medium transition-all w-full text-left border mb-1';
    const buttons = [
      { filter: 'unreviewed', label: 'Unreviewed' },
      { filter: 'all', label: 'All Events' },
      { filter: 'reviewed', label: 'Reviewed' },
      { filter: 'saved', label: 'Saved' },
      { filter: 'test_events', label: 'Test Events', id: 'btnTestEvents', hidden: !showTestEvents }
    ];
    return buttons.map(b => {
      const cls = getFilterButtonClass(b.filter) + ' ' + btnClass;
      const hidden = b.hidden ? ' hidden' : '';
      const id = b.id ? ` id="${b.id}"` : '';
      return `<button type="button" data-filter="${b.filter}" class="${cls}${hidden}"${id}>${escapeHtml(b.label)}</button>`;
    }).join('');
  }

  function updateFilterButtons() {
    const container = document.getElementById('sidebarPlayerExtras');
    if (!container) return;
    const filterButtons = container.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn => {
      const isActive = btn.dataset.filter === currentFilter;
      if (isActive) {
        btn.classList.remove('bg-gray-800', 'text-gray-300', 'border-gray-700');
        btn.classList.add('bg-brand/20', 'text-brand', 'border-brand/30');
      } else {
        btn.classList.add('bg-gray-800', 'text-gray-300', 'border-gray-700');
        btn.classList.remove('bg-brand/20', 'text-brand', 'border-brand/30');
      }
    });
  }

  // --- Flash ---
  function showFlash(msg) {
    flashEl.textContent = msg;
    flashEl.classList.remove('opacity-0');
    flashEl.classList.add('opacity-100');
    setTimeout(() => {
      flashEl.classList.remove('opacity-100');
      flashEl.classList.add('opacity-0');
    }, 1500);
  }

  // --- API ---
  async function fetchEvents(opts) {
    const silent = opts && opts.silent;
    const forceAll = !!(opts && opts.forceAll);
    const camera = '';

    try {
      const base = camera ? `/events/${encodeURIComponent(camera)}` : '/events';
      const resp = await fetch(`${base}?filter=${currentFilter}`);
      const data = await resp.json();
      const newEvents = data.events || [];

      hasLoadedOnce = true;
      if (silent) {
        const currentId = events[currentIndex] ? events[currentIndex].event_id : null;
        events = newEvents;
        if (currentId) {
          const idx = events.findIndex(e => e.event_id === currentId);
          currentIndex = idx >= 0 ? idx : 0;
        } else {
          currentIndex = 0;
        }
        if (newEvents.length !== events.length) {
          showFlash('Updated');
        }
      } else {
        events = newEvents;
        currentIndex = 0;
        if (urlCamera && urlSubdir && events.length > 0) {
          const idx = events.findIndex(e => (e.camera || '').toLowerCase() === urlCamera.toLowerCase() && (e.subdir || (e.hosted_clip && e.hosted_clip.split('/').slice(-2, -1)[0])) === urlSubdir);
          if (idx >= 0) {
            currentIndex = idx;
          }
        }
      }

      render();
    } catch (e) {
      console.error('Failed to fetch events:', e);
      if (opts && opts.silent && hasLoadedOnce) {
        showRefreshToast();
        return;
      }
      if (!(opts && opts.silent)) {
        mainContent.innerHTML = `
          <div class="text-center py-20 text-gray-500">
            <h2 class="text-xl text-gray-400 mb-2">Error loading events</h2>
            <p>Could not connect to the API.</p>
          </div>`;
      }
    }
  }

  function showRefreshToast() {
    let toast = document.getElementById('playerRefreshToast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'playerRefreshToast';
      toast.className = 'fixed bottom-4 right-4 z-50 px-4 py-2 rounded-lg bg-amber-900/90 text-amber-200 text-sm border border-amber-700/50 shadow-lg';
      document.body.appendChild(toast);
    }
    toast.textContent = 'Could not refresh events. Retrying on next interval.';
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 4000);
  }

  function getEventPath(ev) {
    if (ev.saved) return 'saved/' + (ev.camera || '') + '/' + (ev.subdir || '');
    return (ev.camera || '') + '/' + (ev.subdir || '');
  }

  async function deleteEvent(eventPath) {
    if (!confirm('Delete this event? This cannot be undone.')) return;
    try {
      const resp = await fetch('/delete/' + eventPath.split('/').map(encodeURIComponent).join('/'), { method: 'POST' });
      if (resp.ok) {
        events.splice(currentIndex, 1);
        if (currentIndex >= events.length) currentIndex = Math.max(0, events.length - 1);
        render();
      } else {
        alert('Failed to delete event.');
      }
    } catch (e) {
      alert('Error deleting event: ' + e.message);
    }
  }

  async function keepEvent(ev) {
    const keepPath = (ev.camera || '') + '/' + (ev.subdir || '');
    try {
      const resp = await fetch('/keep/' + keepPath.split('/').map(encodeURIComponent).join('/'), { method: 'POST' });
      const data = resp.ok ? await resp.json().catch(() => ({})) : {};
      if (resp.ok) {
        events.splice(currentIndex, 1);
        if (currentIndex >= events.length) currentIndex = Math.max(0, events.length - 1);
        showFlash('Event saved');
        render();
      } else {
        alert(data.message || 'Failed to keep event.');
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function markViewed(eventPath) {
    try {
      await fetch('/viewed/' + eventPath.split('/').map(encodeURIComponent).join('/'), { method: 'POST' });
      if (currentFilter === 'unreviewed') {
        events.splice(currentIndex, 1);
        if (currentIndex >= events.length) currentIndex = Math.max(0, events.length - 1);
      } else {
        events[currentIndex].viewed = true;
      }
      render();
    } catch (e) {
      console.error('Error marking viewed:', e);
    }
  }

  async function markAllViewed() {
    if (!confirm('Mark all events as reviewed?')) return;
    try {
      const resp = await fetch('/viewed/all', { method: 'POST' });
      if (resp.ok) {
        if (currentFilter === 'unreviewed') {
          events = [];
          currentIndex = 0;
        } else {
          events.forEach(e => e.viewed = true);
        }
        render();
        showFlash('All marked reviewed');
      }
    } catch (e) {
      console.error('Error marking all viewed:', e);
    }
  }

  function renderAiAnalysisBlocks(ev) {
    const placeholderText = 'future screenshot analysis';
    const firstLineText = (ev.title != null && ev.title !== '') ? ev.title : placeholderText;
    const firstLineHtml = firstLineText === placeholderText
      ? `<p class="italic text-gray-500 mb-3">${escapeHtml(firstLineText)}</p>`
      : `<h3 class="text-brand text-lg font-semibold mb-2">${escapeHtml(firstLineText)}</h3>`;
    const sceneText = ev.scene != null && ev.scene !== '' ? escapeHtml(ev.scene) : 'No scene description.';
    const sceneHtml = `<p class="text-gray-300 leading-relaxed">${sceneText}</p>`;
    return firstLineHtml + sceneHtml;
  }

  function getThreatBadge(threatLevel) {
    const labels = {0: 'Normal', 1: 'Suspicious', 2: 'Critical'};
    const colors = {
      0: 'bg-green-900/50 text-green-400 border-green-700/50',
      1: 'bg-amber-900/50 text-amber-400 border-amber-700/50',
      2: 'bg-red-900/50 text-red-400 border-red-700/50 animate-pulse'
    };
    if (threatLevel === 0) return '';
    return `<span class="ml-2 px-2 py-1 rounded-md text-xs font-semibold border ${colors[threatLevel]}">${labels[threatLevel]}</span>`;
  }

  // --- Render ---
  function render() {
    const sidebarExtras = document.getElementById('sidebarPlayerExtras');

    if (events.length === 0) {
      const filterLabel = currentFilter === 'reviewed' ? 'reviewed' : currentFilter === 'unreviewed' ? 'unreviewed' : currentFilter === 'saved' ? 'saved' : currentFilter === 'test_events' ? 'test' : '';
      if (sidebarExtras) {
        sidebarExtras.innerHTML = buildSidebarFilterButtonsHtml(true);
        lastShowTestEvents = true;
      }
      mainContent.innerHTML = `
        <div class="text-center py-20 text-gray-500">
          <h2 class="text-2xl text-gray-400 mb-3">No Events Found</h2>
          <p class="mb-4">No ${filterLabel} events.</p>
          <a href="/stats-page" class="text-brand hover:underline">View Stats</a>
        </div>`;
      return;
    }

    const ev = events[currentIndex];
    const eventPath = getEventPath(ev);

    // Show/hide test events filter based on consolidated status (built into sidebar HTML)
    if (!ev.consolidated && currentFilter === 'test_events') {
      currentFilter = 'all';
      updateFilterButtons();
    }

    const ts = ev.timestamp ? new Date(parseInt(ev.timestamp) * 1000) : null;
    const endTs = ev.end_timestamp != null ? new Date(Math.round(parseFloat(ev.end_timestamp) * 1000)) : null;
    const dateStr = ts ? ts.toLocaleDateString() : 'Unknown';
    const startTimeStr = ts ? ts.toLocaleTimeString() : '—';
    const endTimeStr = endTs ? endTs.toLocaleTimeString() : 'Ongoing';
    const durationSec = (ts && endTs && ev.end_timestamp != null)
      ? (parseFloat(ev.end_timestamp) - parseFloat(ev.timestamp))
      : null;
    const durationStr = formatDuration(durationSec);
    const cameraDisplay = ev.camera.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    const labelDisplay = (ev.label || 'unknown').replace(/\b\w/g, c => c.toUpperCase());
    const subdir = ev.subdir || (ev.hosted_clip && ev.hosted_clip.split('/').slice(-2, -1)[0]);
    const threatLevel = ev.threat_level || 0;

    const clips = ev.hosted_clips || (ev.hosted_clip ? [{ camera: ev.camera || 'Clip', url: ev.hosted_clip }] : []);
    const primaryClipUrl = ev.hosted_clip || (clips[0] && clips[0].url) || '';

    // Build clip selector buttons for multi-cam
    let clipSelectorHtml = '';
    if (clips.length > 1) {
      clipSelectorHtml = `
        <div class="flex flex-wrap gap-2">
          ${clips.map((c, idx) => `
            <button class="clip-btn px-3 py-1.5 rounded-lg text-xs font-medium transition-all ${idx === 0 ? 'bg-brand/20 text-brand border border-brand/30' : 'bg-gray-800 text-gray-300 border border-gray-700 hover:bg-gray-700'}"
                    data-url="${escapeHtml(c.url)}">
              ${escapeHtml((c.camera || 'Camera').replace(/_/g, ' ').replace(/\b\w/g, ch => ch.toUpperCase()))}
            </button>
          `).join('')}
        </div>`;
    }

    // Sidebar: filter buttons — only rebuild when Test Events visibility changes
    const showTestEvents = ev.consolidated;
    if (sidebarExtras) {
      if (lastShowTestEvents !== showTestEvents) {
        sidebarExtras.innerHTML = buildSidebarFilterButtonsHtml(showTestEvents);
        lastShowTestEvents = showTestEvents;
      }
      updateFilterButtons();
    }

    // Build action bar for under the video (order: Timeline, Delete, Keep, Download)
    const actionBarItems = [];
    actionBarItems.push(`<a href="/events/${escapeHtml(eventPath)}/timeline" class="flex-1 min-w-0 inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm font-medium bg-gray-800 text-gray-300 border border-gray-700 hover:bg-gray-700 transition-all"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Timeline</a>`);
    actionBarItems.push(`<button type="button" id="actionDelete" class="flex-1 min-w-0 inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm font-medium bg-red-900/50 text-red-400 border border-red-700/50 hover:bg-red-900/70 transition-all"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Delete</button>`);
    if (!ev.saved) {
      actionBarItems.push(`<button type="button" id="actionKeep" class="flex-1 min-w-0 inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm font-medium bg-blue-900/50 text-blue-400 border border-blue-700/50 hover:bg-blue-900/70 transition-all"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>Keep</button>`);
    }
    if (ev.has_clip) {
      actionBarItems.push(`<a id="actionDownload" href="${escapeHtml(primaryClipUrl)}" download class="flex-1 min-w-0 inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg text-sm font-medium bg-green-900/50 text-green-400 border border-green-700/50 hover:bg-green-900/70 transition-all"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Download</a>`);
    }
    const actionBarHtml = `<div class="flex flex-wrap gap-2 mb-4">${actionBarItems.join('')}</div>`;

    mainContent.innerHTML = `
      <!-- Video Player -->
      <div class="bg-black rounded-xl overflow-hidden shadow-2xl mb-4">
        ${ev.has_clip
          ? `<video id="videoPlayer" controls preload="metadata" class="w-full"
               poster="${ev.has_snapshot ? ev.hosted_snapshot : ''}"
               src="${escapeHtml(primaryClipUrl)}">
               Your browser does not support the video tag.
             </video>`
          : ev.has_snapshot
            ? `<img src="${ev.hosted_snapshot}" alt="Snapshot" class="w-full">`
            : `<div class="flex items-center justify-center min-h-[240px] text-gray-500 text-lg">No media available</div>`
        }
      </div>

      <!-- Navigation & Clip Selector -->
      <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between mb-4">
        <!-- Navigation -->
        <div class="flex items-center gap-3">
          <button id="btnNewer" ${currentIndex <= 0 ? 'disabled' : ''} class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-800 text-gray-300 border border-gray-700 hover:bg-gray-700 transition-all disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            Newer
          </button>
          <span class="text-gray-400 text-sm font-medium">
            ${currentIndex + 1} / ${events.length}
            ${ev.viewed ? '<span class="ml-2 px-2 py-0.5 rounded bg-green-900/50 text-green-400 text-xs">Reviewed</span>' : ''}
            ${ev.ongoing ? '<span class="ml-2 px-2 py-0.5 rounded bg-green-900/30 text-green-400 text-xs animate-pulse">Event ongoing</span>' : ''}
          </span>
          <button id="btnOlder" ${currentIndex >= events.length - 1 ? 'disabled' : ''} class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-800 text-gray-300 border border-gray-700 hover:bg-gray-700 transition-all disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-1">
            Older
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>
        </div>

        <!-- Clip Selector -->
        ${clipSelectorHtml}
      </div>

      <!-- Mark Reviewed Bar: Click to Review (left 4/5) + Mark All Reviewed (right 1/5) -->
      ${!ev.viewed ? `
        <div class="flex gap-2 mb-4">
          <button id="btnMarkReviewed" class="flex-[4_4_80%] min-w-0 px-4 py-3 rounded-lg text-sm font-medium bg-green-900/50 text-green-400 border border-green-700/50 hover:bg-green-900/70 transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            <span class="truncate">Click to Review</span>
          </button>
          ${(currentFilter !== 'saved' && currentFilter !== 'test_events') ? `
          <button id="btnMarkAll" class="flex-[1_1_20%] min-w-0 px-4 py-3 rounded-lg text-sm font-medium bg-amber-900/50 text-amber-400 border border-amber-700/50 hover:bg-amber-900/70 transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            <span class="truncate">Mark All Reviewed</span>
          </button>
          ` : '<div class="flex-[1_1_20%] flex-shrink-0"></div>'}
        </div>
      ` : ''}

      ${actionBarHtml}

      <!-- AI Analysis Card -->
      <div class="bg-cardbg border border-cardborder rounded-xl p-5 mb-4 shadow-lg">
        <h2 class="text-lg font-semibold text-brand mb-3 flex items-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
          AI Analysis
          ${getThreatBadge(threatLevel)}
        </h2>
        <div id="aiAnalysisContainer"></div>
      </div>

      <!-- Event Details Card -->
      <div class="bg-cardbg border border-cardborder rounded-xl p-5 shadow-lg">
        <h2 class="text-lg font-semibold text-brand mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          Event Details
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3 text-sm">
          <div class="flex justify-between md:block">
            <span class="text-gray-500 font-medium">Date</span>
            <span class="text-gray-200">${escapeHtml(dateStr)}</span>
          </div>
          <div class="flex justify-between md:block">
            <span class="text-gray-500 font-medium">Start</span>
            <span class="text-gray-200">${escapeHtml(startTimeStr)}</span>
          </div>
          <div class="flex justify-between md:block">
            <span class="text-gray-500 font-medium">End</span>
            <span class="text-gray-200">${escapeHtml(endTimeStr)}</span>
          </div>
          <div class="flex justify-between md:block">
            <span class="text-gray-500 font-medium">Duration</span>
            <span class="text-gray-200">${escapeHtml(durationStr)}</span>
          </div>
          <div class="col-span-1 md:col-span-2">
            <span class="text-gray-500 font-medium block mb-1">Cameras & Zones</span>
            <div class="text-gray-200">
              ${((ev.cameras_with_zones && ev.cameras_with_zones.length) ? ev.cameras_with_zones : [{camera: ev.camera, zones: []}])
                .map(c => {
                  const cam = escapeHtml((c.camera || '').replace(/_/g, ' ').replace(/\b\w/g, ch => ch.toUpperCase()));
                  const zones = (c.zones && c.zones.length) ? c.zones.join(', ') : 'No Zones Indicated';
                  return `<div class="mb-1"><span class="text-gray-300">${cam}:</span> <span class="text-gray-400">${escapeHtml(zones)}</span></div>`;
                }).join('')}
            </div>
          </div>
          <div class="flex justify-between md:block">
            <span class="text-gray-500 font-medium">Label</span>
            <span class="text-gray-200">${escapeHtml(labelDisplay)}</span>
          </div>
          ${ev.severity ? `
            <div class="flex justify-between md:block">
              <span class="text-gray-500 font-medium">Severity</span>
              <span class="text-gray-200">${escapeHtml(ev.severity)}</span>
            </div>
          ` : ''}
          ${threatLevel > 0 ? `
            <div class="flex justify-between md:block">
              <span class="text-gray-500 font-medium">Threat Level</span>
              <span>${getThreatBadge(threatLevel)}</span>
            </div>
          ` : ''}
          <div class="col-span-1 md:col-span-2 pt-2 border-t border-gray-700">
            <span class="text-gray-500 font-medium text-xs">Event ID</span>
            <span class="text-gray-500 text-xs ml-2 font-mono">${escapeHtml(ev.event_id)}</span>
          </div>
        </div>
      </div>`;

    // Bind navigation
    const btnNewer = document.getElementById('btnNewer');
    const btnOlder = document.getElementById('btnOlder');
    const btnMarkReviewed = document.getElementById('btnMarkReviewed');
    const video = document.getElementById('videoPlayer');

    if (btnNewer) btnNewer.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; render(); } });
    if (btnOlder) btnOlder.addEventListener('click', () => { if (currentIndex < events.length - 1) { currentIndex++; render(); } });

    // Bind clip selector buttons
    const clipButtons = document.querySelectorAll('.clip-btn');
    clipButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const url = btn.dataset.url;
        if (video) video.src = url;
        const dl = document.getElementById('actionDownload');
        if (dl) dl.href = url;
        // Update active state
        clipButtons.forEach(b => {
          b.classList.remove('bg-brand/20', 'text-brand', 'border-brand/30');
          b.classList.add('bg-gray-800', 'text-gray-300', 'border-gray-700');
        });
        btn.classList.remove('bg-gray-800', 'text-gray-300', 'border-gray-700');
        btn.classList.add('bg-brand/20', 'text-brand', 'border-brand/30');
      });
    });

    // Bind action buttons
    const actionKeep = document.getElementById('actionKeep');
    if (actionKeep) actionKeep.addEventListener('click', () => keepEvent(ev));
    const actionDelete = document.getElementById('actionDelete');
    if (actionDelete) actionDelete.addEventListener('click', () => deleteEvent(eventPath));
    if (btnMarkReviewed) btnMarkReviewed.addEventListener('click', () => markViewed(eventPath));
    const btnMarkAll = document.getElementById('btnMarkAll');
    if (btnMarkAll) btnMarkAll.addEventListener('click', markAllViewed);

    // Track video playing state
    if (video) {
      video.addEventListener('play', () => { videoPlaying = true; });
      video.addEventListener('pause', () => { videoPlaying = false; });
      video.addEventListener('ended', () => { videoPlaying = false; });
    }

    // Populate AI Analysis
    const aiContainer = document.getElementById('aiAnalysisContainer');
    if (aiContainer) {
      aiContainer.innerHTML = renderAiAnalysisBlocks(ev);
      lastRenderedEventId = ev.event_id;
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatDuration(sec) {
    if (sec == null || typeof sec !== 'number' || sec < 0) return '—';
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    const h = Math.floor(m / 60);
    const min = m % 60;
    if (h > 0) return `${h}h ${min}m ${s}s`;
    if (min > 0) return `${min}m ${s}s`;
    return `${s}s`;
  }

  function startAutoRefresh() {
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(() => {
      if (!videoPlaying) {
        fetchEvents({ silent: true });
      }
    }, 30000);
  }

  // --- Init ---
  const urlParams = new URLSearchParams(window.location.search);
  const urlFilter = urlParams.get('filter');
  const urlCamera = urlParams.get('camera');
  const urlSubdir = urlParams.get('subdir');
  if (urlFilter && ['all', 'reviewed', 'unreviewed', 'saved', 'test_events'].includes(urlFilter)) {
    currentFilter = urlFilter;
    updateFilterButtons();
  }

  (async function init() {
    await fetchEvents({ forceAll: !!urlSubdir });
    startAutoRefresh();
  })();
})();
</script>
{% endblock %}
