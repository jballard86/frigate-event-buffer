alias: "Frigate Orchestrator: Phone Notifications"
description: "Terminal automation with validation and optional toggles."
triggers:
  - trigger: mqtt
    topic: frigate/custom/notifications
actions:
  - variables:
      # --- DATA MAPPING ---
      payload: "{{ trigger.payload_json }}"
      target_phone: "{{ states('input_text.notification_target_phone') }}"

  # --- Point 1: Validation ---
  # Only proceed if the phone helper is actually set
  - condition: template
    value_template: "{{ target_phone | length > 0 }}"

  - action: "notify.{{ target_phone }}"
    data:
      title: "{{ payload.title }}"
      message: "{{ payload.message }}"
      data:
        # Point 5: Tagging manages sticky accumulation per event
        tag: "{{ payload.tag }}" 
        
        # Clicking the notification opens the event viewer
        url: "{{ states('input_text.frigate_buffer_url') }}/player"
        clickAction: "{{ states('input_text.frigate_buffer_url') }}/player"
        
        # Phase-based Media
        image: "{{ payload.image_url }}"
        video: "{{ payload.video_url }}"

        # Sound only on first notification, silent updates thereafter
        importance: "{{ 'high' if payload.status == 'new' else 'low' }}"
        ttl: 0
        sound: "{{ 'default' if payload.status == 'new' else 'none' }}"
        
        # Persistence settings
        sticky: true
        notification_icon: "mdi:shield-check"

  # --- Dashboard Refresh Logic ---
  - if:
      - condition: template
        value_template: "{{ payload.status in ['clip_ready', 'finalized'] }}"
    then:
      - action: homeassistant.update_entity
        target:
          entity_id: sensor.frigate_feed_raw
      - action: input_number.set_value
        target:
          entity_id: input_number.security_event_index
        data:
          value: 0

#Helper Creation instructions:
  #First, go to Settings > Devices & Services > Helpers and create a new Text helper:
  #Name: Notification Target Phone
  #Entity ID: input_text.notification_target_phone
  #Value: mobile_app_sm_s928u (or your current phone's service name)