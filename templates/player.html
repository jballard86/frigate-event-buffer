<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frigate Event Viewer</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
  }

  /* Header */
  .header {
    background: #16213e;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #0f3460;
    flex-wrap: wrap;
    gap: 8px;
  }

  .header h1 {
    font-size: 1.1rem;
    color: #e94560;
    white-space: nowrap;
  }

  .header-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  select {
    background: #0f3460;
    color: #e0e0e0;
    border: 1px solid #533483;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 0.85rem;
    cursor: pointer;
  }

  select:focus { outline: 2px solid #e94560; }

  /* Main single-column layout */
  .main {
    max-width: 800px;
    margin: 0 auto;
    padding: 16px;
  }

  /* Video player */
  .video-container {
    background: #000;
    border-radius: 8px;
    overflow: hidden;
  }

  .video-container video,
  .video-container img {
    width: 100%;
    display: block;
  }

  .no-video {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 240px;
    color: #666;
    font-size: 1.1rem;
  }

  /* Navigation bar */
  .nav-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 10px;
    gap: 8px;
    flex-wrap: wrap;
  }

  .nav-bar .event-counter {
    color: #999;
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .nav-buttons {
    display: flex;
    gap: 6px;
  }

  button {
    background: #0f3460;
    color: #e0e0e0;
    border: 1px solid #533483;
    border-radius: 6px;
    padding: 7px 14px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
  }

  button:hover:not(:disabled) { background: #533483; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-danger { background: #5c1a1a; border-color: #8b2020; }
  .btn-danger:hover:not(:disabled) { background: #8b2020; }

  .btn-download { background: #1a4a1a; border-color: #2d7a2d; }
  .btn-download:hover { background: #2d7a2d; }

  .btn-success { background: #1a4a1a; border-color: #2d7a2d; }
  .btn-success:hover:not(:disabled) { background: #2d7a2d; }

  .btn-mark-all { background: #4a3a1a; border-color: #7a6a2d; }
  .btn-mark-all:hover:not(:disabled) { background: #7a6a2d; }

  /* Info cards */
  .info-card {
    background: #16213e;
    border: 1px solid #0f3460;
    border-radius: 8px;
    padding: 14px;
    margin-top: 10px;
  }

  .info-card h2 {
    font-size: 0.95rem;
    color: #e94560;
    margin-bottom: 8px;
    border-bottom: 1px solid #0f3460;
    padding-bottom: 6px;
  }

  .meta-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 4px 12px;
    font-size: 0.9rem;
  }

  .meta-label { color: #888; font-weight: 500; }
  .meta-value { color: #e0e0e0; word-break: break-word; }

  .description-text {
    font-size: 0.9rem;
    line-height: 1.5;
    color: #ccc;
    white-space: pre-wrap;
  }

  .ai-title {
    font-weight: 600;
    margin-bottom: 6px;
    color: #e0e0e0;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .empty-state h2 {
    font-size: 1.3rem;
    color: #888;
    margin-bottom: 10px;
  }

  .empty-state .stats-below { margin-top: 24px; }

  /* Stats panel - symmetrical, centered layout */
  .stats-panel { margin-top: 16px; text-align: center; }
  .stats-panel .info-card {
    margin-top: 12px;
    text-align: center;
  }
  .stats-panel .info-card:first-of-type { margin-top: 0; }
  .stats-panel .info-card h2 { text-align: center; }
  .stats-panel .stats-row {
    display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
    gap: 16px 24px; margin: 8px 0; font-size: 0.9rem; text-align: center;
  }
  .stats-panel .stats-item { display: flex; gap: 6px; justify-content: center; }
  .stats-panel .stats-item strong { color: #e94560; min-width: 4ch; }
  .stats-panel .errors-list {
    max-height: 200px; overflow-y: auto; font-size: 0.8rem; font-family: monospace;
    background: #0f3460; border-radius: 4px; padding: 8px; margin: 8px auto;
    text-align: left; max-width: 100%;
  }
  .stats-panel .errors-list .err-item { margin: 6px 0; padding: 4px 0; border-bottom: 1px solid #1a1a2e; word-break: break-word; }
  .stats-panel .errors-list .err-ts { color: #888; margin-right: 8px; }
  .stats-panel .errors-footer { font-size: 0.8rem; color: #666; margin-top: 8px; text-align: center; }
  .stats-panel .camera-table {
    margin: 0 auto; border-collapse: collapse; font-size: 0.9rem;
  }
  .stats-panel .camera-table td { padding: 6px 16px; border-bottom: 1px solid #0f3460; text-align: center; }
  .stats-panel .camera-table .meta-label { padding-right: 12px; text-align: center; }
  .stats-panel .meta-grid {
    display: grid; grid-template-columns: auto auto;
    justify-content: center; justify-items: start; gap: 4px 16px;
    margin: 8px auto; text-align: left; max-width: fit-content;
  }

  /* Loading */
  .loading {
    text-align: center;
    padding: 40px;
    color: #888;
  }

  /* Updated flash */
  .flash {
    position: fixed;
    top: 8px;
    right: 8px;
    background: #2d7a2d;
    color: #fff;
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 0.8rem;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 100;
  }

  .flash.show { opacity: 1; }

  /* Viewed badge */
  .viewed-badge {
    display: inline-block;
    background: #2d7a2d;
    color: #fff;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 8px;
    vertical-align: middle;
  }

  /* Threat level badges */
  .threat-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 8px;
    vertical-align: middle;
  }
  .threat-0 { background: #1a4a1a; color: #7dde7d; }
  .threat-1 { background: #4a3a1a; color: #deb87d; }
  .threat-2 { background: #5c1a1a; color: #ff6b6b; animation: pulse-red 1.5s infinite; }
  @keyframes pulse-red {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* Collapsible review summary */
  .summary-excerpt {
    font-size: 0.9rem;
    line-height: 1.5;
    color: #ccc;
  }
  .summary-full {
    display: none;
    margin-top: 8px;
  }
  .summary-full.expanded { display: block; }
  .btn-expand {
    background: none;
    border: 1px solid #533483;
    color: #e94560;
    padding: 4px 12px;
    font-size: 0.8rem;
    margin-top: 8px;
    cursor: pointer;
  }
  .btn-expand:hover { background: #0f3460; }

  /* Rendered markdown content */
  .markdown-content h1, .markdown-content h2, .markdown-content h3 {
    color: #e94560;
    margin: 12px 0 6px 0;
  }
  .markdown-content h1 { font-size: 1.05rem; }
  .markdown-content h2 { font-size: 0.95rem; }
  .markdown-content h3 { font-size: 0.9rem; }
  .markdown-content p { margin: 6px 0; line-height: 1.5; color: #ccc; }
  .markdown-content ul, .markdown-content ol { margin: 6px 0 6px 20px; color: #ccc; }
  .markdown-content li { margin: 3px 0; }
  .markdown-content strong { color: #fff; }
  .markdown-content hr { border-color: #0f3460; margin: 10px 0; }

  /* Responsive: mobile */
  @media (max-width: 600px) {
    .header { padding: 10px 12px; }
    .header h1 { font-size: 0.95rem; }
    .main { padding: 10px; }
    button { padding: 6px 10px; font-size: 0.8rem; }
  }
</style>
<script src="/static/marked.min.js"></script>
<script src="/static/purify.min.js"></script>
</head>
<body>

<div class="header">
  <h1>Frigate Event Viewer</h1>
  <div class="header-controls">
    <select id="cameraSelect">
      <option value="">All Cameras</option>
    </select>
    <select id="filterSelect">
      <option value="unreviewed">Unreviewed</option>
      <option value="all">All Events</option>
      <option value="reviewed">Reviewed</option>
      <option value="stats">Stats</option>
    </select>
    <button class="btn-mark-all" id="btnMarkAll">Mark All Reviewed</button>
    <button id="btnRefreshStats" style="display:none;">Refresh Stats</button>
    <a href="/daily-review"><button>Daily Review</button></a>
  </div>
</div>

<div class="flash" id="flash"></div>

<div id="mainContent" class="main">
  <div class="loading">Loading events...</div>
</div>

<script>
  window.STATS_REFRESH_SECONDS = {{ stats_refresh_seconds|default(60)|int }};
</script>
<script>
(function() {
  'use strict';

  let events = [];
  let currentIndex = 0;
  let refreshTimer = null;
  let videoPlaying = false;

  const cameraSelect = document.getElementById('cameraSelect');
  const filterSelect = document.getElementById('filterSelect');
  const mainContent = document.getElementById('mainContent');
  const btnMarkAll = document.getElementById('btnMarkAll');
  const btnRefreshStats = document.getElementById('btnRefreshStats');
  const flashEl = document.getElementById('flash');
  let statsRefreshTimer = null;

  // --- Flash ---
  function showFlash(msg) {
    flashEl.textContent = msg;
    flashEl.classList.add('show');
    setTimeout(() => flashEl.classList.remove('show'), 1500);
  }

  // --- API ---
  async function fetchCameras() {
    try {
      const resp = await fetch('/cameras');
      const data = await resp.json();
      data.cameras.forEach(cam => {
        const opt = document.createElement('option');
        opt.value = cam;
        opt.textContent = cam.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        cameraSelect.appendChild(opt);
      });
    } catch (e) {
      console.error('Failed to fetch cameras:', e);
    }
  }

  async function fetchStats() {
    try {
      const resp = await fetch('/stats');
      const data = await resp.json();
      renderStats(data);
    } catch (e) {
      console.error('Failed to fetch stats:', e);
      const container = document.getElementById('statsContainer');
      const target = container || mainContent;
      target.innerHTML = '<p style="color:#e94560;">Failed to load stats.</p>';
    }
  }

  function renderStats(data) {
    const c = data.events || {};
    const s = data.storage || {};
    const errs = data.errors || [];
    const lc = data.last_cleanup;
    const mr = data.most_recent;
    const sys = data.system || {};

    const fmtStorage = (cam) => {
      if (!cam) return '-';
      if (cam.gb != null) return cam.gb + ' GB';
      if (cam.mb != null) return cam.mb + ' MB';
      return '-';
    };
    const totalStorage = s.total_gb != null ? s.total_gb + ' GB' : (s.total_mb != null ? s.total_mb + ' MB' : '-');

    const byCam = c.by_camera || {};
    const camRows = Object.entries(byCam).map(([name, count]) =>
      `<tr><td class="meta-label">${escapeHtml(name.replace(/_/g, ' '))}</td><td>${count}</td></tr>`
    ).join('');

    const storageRows = Object.entries(s.by_camera || {}).map(([name, val]) =>
      `<tr><td class="meta-label">${escapeHtml(name.replace(/_/g, ' '))}</td><td>${fmtStorage(val)}</td></tr>`
    ).join('');

    const bd = s.breakdown || {};
    const errItems = errs.slice(0, 10).map(e =>
      `<div class="err-item"><span class="err-ts">${escapeHtml(e.ts || '')}</span>${escapeHtml((e.message || '').substring(0, 300))}</div>`
    ).join('');

    const uptime = sys.uptime_seconds != null ? Math.floor(sys.uptime_seconds / 60) + ' min' : '-';

    let html = `
      <div class="stats-panel" id="statsContainer">
        <div class="info-card">
          <h2>Event Counts</h2>
          <div class="stats-row">
            <span class="stats-item"><strong>Today:</strong> ${c.today ?? 0}</span>
            <span class="stats-item"><strong>This Week:</strong> ${c.this_week ?? 0}</span>
            <span class="stats-item"><strong>This Month:</strong> ${c.this_month ?? 0}</span>
          </div>
          <div class="stats-row">
            <span class="stats-item"><strong>Reviewed:</strong> ${c.total_reviewed ?? 0}</span>
            <span class="stats-item"><strong>Unreviewed:</strong> ${c.total_unreviewed ?? 0}</span>
          </div>
        </div>
        <div class="info-card">
          <h2>Events by Camera</h2>
          <table class="camera-table"><tbody>${camRows || '<tr><td>No cameras</td></tr>'}</tbody></table>
        </div>
        <div class="info-card">
          <h2>Storage</h2>
          <div class="stats-row">
            <span class="stats-item"><strong>Total:</strong> ${totalStorage}</span>
          </div>
          <div class="stats-row" style="margin-top:8px;">
            <span class="meta-label">Clips:</span> ${bd.clips_mb ?? 0} MB |
            <span class="meta-label">Snapshots:</span> ${bd.snapshots_mb ?? 0} MB |
            <span class="meta-label">Descriptions:</span> ${bd.descriptions_mb ?? 0} MB
          </div>
          ${storageRows ? `<table class="camera-table" style="margin-top:8px;"><tbody>${storageRows}</tbody></table>` : ''}
        </div>
        <div class="info-card">
          <h2>Recent Activity</h2>
          <div class="stats-row">
            ${lc ? `<span class="stats-item"><strong>Last cleanup:</strong> ${escapeHtml(lc.at)} (deleted ${lc.deleted})</span>` : '<span class="stats-item">No cleanup recorded yet</span>'}
          </div>
          ${mr ? `<div class="stats-row"><a href="${escapeHtml(mr.url)}" style="color:#e94560;">View most recent notification</a></div>` : ''}
        </div>
        <div class="info-card">
          <h2>Errors</h2>
          ${errItems ? `<div class="errors-list">${errItems}</div><p class="errors-footer">See container logs for full error history.</p>` : '<p>No recent errors.</p>'}
        </div>
        <div class="info-card">
          <h2>System</h2>
          <div class="meta-grid">
            <span class="meta-label">Uptime</span>
            <span class="meta-value">${uptime}</span>
            <span class="meta-label">MQTT</span>
            <span class="meta-value">${sys.mqtt_connected ? 'Connected' : 'Disconnected'}</span>
            <span class="meta-label">Active events</span>
            <span class="meta-value">${sys.active_events ?? 0}</span>
            <span class="meta-label">Retention</span>
            <span class="meta-value">${sys.retention_days ?? '-'} days</span>
            <span class="meta-label">Cleanup interval</span>
            <span class="meta-value">${sys.cleanup_interval_hours ?? '-'} hrs</span>
            ${sys.storage_path ? `<span class="meta-label">Storage path</span><span class="meta-value" style="font-size:0.8rem;">${escapeHtml(sys.storage_path)}</span>` : ''}
          </div>
        </div>
      </div>`;

    const container = document.getElementById('statsContainer');
    if (container) {
      container.outerHTML = html;
    } else {
      mainContent.innerHTML = html;
    }
  }

  async function fetchEvents(opts) {
    const camera = cameraSelect.value;
    const filter = filterSelect.value;
    const silent = opts && opts.silent;

    if (filter === 'stats') {
      mainContent.innerHTML = '<div class="loading">Loading stats...</div>';
      await fetchStats();
      return;
    }

    try {
      const base = camera ? `/events/${encodeURIComponent(camera)}` : '/events';
      const resp = await fetch(`${base}?filter=${filter}`);
      const data = await resp.json();
      const newEvents = data.events || [];

      if (silent) {
        // Preserve position by event_id
        const currentId = events[currentIndex] ? events[currentIndex].event_id : null;
        events = newEvents;
        if (currentId) {
          const idx = events.findIndex(e => e.event_id === currentId);
          currentIndex = idx >= 0 ? idx : 0;
        } else {
          currentIndex = 0;
        }
        if (newEvents.length !== events.length) {
          showFlash('Updated');
        }
      } else {
        events = newEvents;
        currentIndex = 0;
        // Back from timeline: seek to same event
        if (urlCamera && urlSubdir && events.length > 0) {
          const idx = events.findIndex(e => (e.camera || '').toLowerCase() === urlCamera.toLowerCase() && (e.subdir || e.hosted_clip?.split('/').slice(-2, -1)[0]) === urlSubdir);
          if (idx >= 0) {
            currentIndex = idx;
          }
        }
      }

      render();
    } catch (e) {
      console.error('Failed to fetch events:', e);
      if (!silent) {
        mainContent.innerHTML = '<div class="empty-state"><h2>Error loading events</h2><p>Could not connect to the API.</p></div>';
      }
    }
  }

  async function deleteEvent(camera, subdir) {
    if (!confirm('Delete this event? This cannot be undone.')) return;
    try {
      const resp = await fetch(`/delete/${camera}/${subdir}`, { method: 'POST' });
      if (resp.ok) {
        events.splice(currentIndex, 1);
        if (currentIndex >= events.length) currentIndex = Math.max(0, events.length - 1);
        render();
      } else {
        alert('Failed to delete event.');
      }
    } catch (e) {
      alert('Error deleting event: ' + e.message);
    }
  }

  async function markViewed(camera, subdir) {
    try {
      await fetch(`/viewed/${camera}/${subdir}`, { method: 'POST' });
      // If viewing unreviewed, remove from list; otherwise update in place
      if (filterSelect.value === 'unreviewed') {
        events.splice(currentIndex, 1);
        if (currentIndex >= events.length) currentIndex = Math.max(0, events.length - 1);
      } else {
        events[currentIndex].viewed = true;
      }
      render();
    } catch (e) {
      console.error('Error marking viewed:', e);
    }
  }

  async function markAllViewed() {
    if (!confirm('Mark all events as reviewed?')) return;
    try {
      const resp = await fetch('/viewed/all', { method: 'POST' });
      if (resp.ok) {
        if (filterSelect.value === 'unreviewed') {
          events = [];
          currentIndex = 0;
        } else {
          events.forEach(e => e.viewed = true);
        }
        render();
        showFlash('All marked reviewed');
      }
    } catch (e) {
      console.error('Error marking all viewed:', e);
    }
  }

  // --- Render ---
  function render() {
    const filter = filterSelect.value;
    if (filter === 'stats') {
      mainContent.innerHTML = '<div class="loading">Loading stats...</div>';
      fetchStats();
      return;
    }
    if (events.length === 0) {
      mainContent.innerHTML = `
        <div class="empty-state">
          <h2>No Events Found</h2>
          <p>No ${filter === 'reviewed' ? 'reviewed' : filter === 'unreviewed' ? 'unreviewed' : ''} events${cameraSelect.value ? ' for this camera' : ''}.</p>
          <div class="stats-below"><div id="statsContainer"><span class="loading">Loading stats...</span></div></div>
        </div>`;
      fetchStats();
      return;
    }

    const ev = events[currentIndex];
    const ts = ev.timestamp ? new Date(parseInt(ev.timestamp) * 1000) : null;
    const timeStr = ts ? ts.toLocaleString() : 'Unknown';
    const title = ev.title || (ev.label || 'Event').replace(/\b\w/g, c => c.toUpperCase()) + ' Detected';
    const description = ev.description || ev.summary || 'No description available.';
    const cameraDisplay = ev.camera.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    const labelDisplay = (ev.label || 'unknown').replace(/\b\w/g, c => c.toUpperCase());
    const subdir = ev.subdir || ev.hosted_clip.split('/').slice(-2, -1)[0];
    const threatLevel = ev.threat_level || 0;
    const threatLabels = {0: 'Normal', 1: 'Suspicious', 2: 'Critical'};
    const threatBadge = threatLevel > 0
      ? ` <span class="threat-badge threat-${threatLevel}">${threatLabels[threatLevel]}</span>`
      : '';

    mainContent.innerHTML = `
      <div class="video-container">
        ${ev.has_clip
          ? `<video id="videoPlayer" controls preload="metadata"
               poster="${ev.has_snapshot ? ev.hosted_snapshot : ''}"
               src="${ev.hosted_clip}">
               Your browser does not support the video tag.
             </video>`
          : ev.has_snapshot
            ? `<img src="${ev.hosted_snapshot}" alt="Snapshot">`
            : `<div class="no-video">No media available</div>`
        }
      </div>

      <div class="nav-bar">
        <div class="nav-buttons">
          <button id="btnNewer" ${currentIndex <= 0 ? 'disabled' : ''}>&#9664; Newer</button>
          <button id="btnOlder" ${currentIndex >= events.length - 1 ? 'disabled' : ''}>Older &#9654;</button>
        </div>
        <span class="event-counter">${currentIndex + 1} / ${events.length}${ev.viewed ? '<span class="viewed-badge">Reviewed</span>' : ''}</span>
        <div class="nav-buttons">
          ${!ev.viewed ? `<button class="btn-success" id="btnMarkReviewed">Reviewed</button>` : ''}
          ${ev.has_clip ? `<a href="${ev.hosted_clip}" download style="text-decoration:none;"><button class="btn-download">Download</button></a>` : ''}
          <a href="/events/${escapeHtml(ev.camera)}/${escapeHtml(subdir)}/timeline" style="text-decoration:none;"><button>View Timeline</button></a>
          <button class="btn-danger" id="btnDelete">Delete</button>
        </div>
      </div>

      <div class="info-card">
        <h2>AI Analysis${threatBadge}</h2>
        ${ev.title ? `<p class="ai-title">${escapeHtml(ev.title)}</p>` : ''}
        ${ev.review_summary
          ? `<div class="summary-excerpt" id="summaryExcerpt"></div>
             <button class="btn-expand" id="btnExpandSummary">Expand Full Report</button>
             <div class="summary-full" id="summaryFull"></div>`
          : `<p class="description-text">${escapeHtml(description)}</p>`
        }
      </div>

      <div class="info-card">
        <h2>Event Details</h2>
        <div class="meta-grid">
          <span class="meta-label">Camera</span>
          <span class="meta-value">${escapeHtml(cameraDisplay)}</span>
          <span class="meta-label">Label</span>
          <span class="meta-value">${escapeHtml(labelDisplay)}</span>
          <span class="meta-label">Time</span>
          <span class="meta-value">${escapeHtml(timeStr)}</span>
          ${ev.severity ? `<span class="meta-label">Severity</span><span class="meta-value">${escapeHtml(ev.severity)}</span>` : ''}
          ${threatLevel > 0 ? `<span class="meta-label">Threat Level</span><span class="meta-value"><span class="threat-badge threat-${threatLevel}">${threatLabels[threatLevel]}</span></span>` : ''}
          <span class="meta-label">Event ID</span>
          <span class="meta-value" style="font-size:0.8rem;color:#888;">${escapeHtml(ev.event_id)}</span>
        </div>
      </div>`;

    // Bind navigation
    const btnNewer = document.getElementById('btnNewer');
    const btnOlder = document.getElementById('btnOlder');
    const btnDelete = document.getElementById('btnDelete');
    const btnMarkReviewed = document.getElementById('btnMarkReviewed');
    const video = document.getElementById('videoPlayer');

    if (btnNewer) btnNewer.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; render(); } });
    if (btnOlder) btnOlder.addEventListener('click', () => { if (currentIndex < events.length - 1) { currentIndex++; render(); } });
    if (btnDelete) btnDelete.addEventListener('click', () => deleteEvent(ev.camera, subdir));
    if (btnMarkReviewed) btnMarkReviewed.addEventListener('click', () => markViewed(ev.camera, subdir));

    // Track video playing state for auto-refresh
    if (video) {
      video.addEventListener('play', () => { videoPlaying = true; });
      video.addEventListener('pause', () => { videoPlaying = false; });
      video.addEventListener('ended', () => { videoPlaying = false; });
    }

    // Render collapsible review summary as markdown
    if (ev.review_summary && typeof marked !== 'undefined') {
      const rawHtml = marked.parse(ev.review_summary);
      const safeHtml = typeof DOMPurify !== 'undefined' ? DOMPurify.sanitize(rawHtml) : rawHtml;

      // Excerpt: first 2-3 meaningful lines
      const lines = ev.review_summary.split('\n').filter(l => l.trim() && !l.trim().startsWith('#'));
      const excerpt = lines.slice(0, 3).join(' ').substring(0, 200);
      const excerptEl = document.getElementById('summaryExcerpt');
      const fullEl = document.getElementById('summaryFull');
      const btnExpand = document.getElementById('btnExpandSummary');

      if (excerptEl) excerptEl.textContent = excerpt + (excerpt.length >= 200 ? '...' : '');
      if (fullEl) { fullEl.innerHTML = '<div class="markdown-content">' + safeHtml + '</div>'; }
      if (btnExpand) {
        btnExpand.addEventListener('click', () => {
          const isExpanded = fullEl.classList.toggle('expanded');
          btnExpand.textContent = isExpanded ? 'Collapse Report' : 'Expand Full Report';
          if (isExpanded && excerptEl) excerptEl.style.display = 'none';
          if (!isExpanded && excerptEl) excerptEl.style.display = '';
        });
      }
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // --- Auto-refresh ---
  function startAutoRefresh() {
    if (refreshTimer) clearInterval(refreshTimer);
    const isStats = filterSelect.value === 'stats';
    const intervalMs = isStats
      ? (window.STATS_REFRESH_SECONDS || 60) * 1000
      : 30000;
    refreshTimer = setInterval(() => {
      if (!videoPlaying) {
        fetchEvents({ silent: true });
      }
    }, intervalMs);
  }

  function updateHeaderForFilter() {
    const isStats = filterSelect.value === 'stats';
    btnMarkAll.style.display = isStats ? 'none' : '';
    btnRefreshStats.style.display = isStats ? '' : 'none';
  }

  // --- Init ---
  // Honor ?filter=all from URL (e.g. "View most recent notification" link)
  const urlParams = new URLSearchParams(window.location.search);
  const urlFilter = urlParams.get('filter');
  const urlCamera = urlParams.get('camera');
  const urlSubdir = urlParams.get('subdir');
  if (urlFilter === 'all') {
    filterSelect.value = 'all';
  }
  if (urlCamera) {
    cameraSelect.value = urlCamera;
  }

  cameraSelect.addEventListener('change', () => fetchEvents());
  filterSelect.addEventListener('change', () => {
    updateHeaderForFilter();
    fetchEvents();
    startAutoRefresh();
  });
  btnMarkAll.addEventListener('click', markAllViewed);
  btnRefreshStats.addEventListener('click', () => fetchStats());

  (async function init() {
    await fetchCameras();
    if (urlCamera) cameraSelect.value = urlCamera;
    await fetchEvents();
    updateHeaderForFilter();
    startAutoRefresh();
  })();
})();
</script>
</body>
</html>
