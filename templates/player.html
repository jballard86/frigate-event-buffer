<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frigate Event Viewer</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
  }

  /* Header */
  .header {
    background: #16213e;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #0f3460;
    flex-wrap: wrap;
    gap: 10px;
  }

  .header h1 {
    font-size: 1.1rem;
    color: #e94560;
    white-space: nowrap;
  }

  .header-controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  select {
    background: #0f3460;
    color: #e0e0e0;
    border: 1px solid #533483;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 0.9rem;
    cursor: pointer;
  }

  select:focus { outline: 2px solid #e94560; }

  /* Main layout */
  .main {
    display: flex;
    gap: 20px;
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
  }

  .video-section {
    flex: 1;
    min-width: 0;
  }

  .info-section {
    width: 360px;
    flex-shrink: 0;
  }

  /* Video player */
  .video-container {
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
  }

  .video-container video {
    width: 100%;
    display: block;
  }

  .no-video {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    color: #666;
    font-size: 1.1rem;
  }

  /* Navigation bar */
  .nav-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 12px;
    gap: 8px;
  }

  .nav-bar .event-counter {
    color: #999;
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .nav-buttons {
    display: flex;
    gap: 6px;
  }

  button {
    background: #0f3460;
    color: #e0e0e0;
    border: 1px solid #533483;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.15s;
    white-space: nowrap;
  }

  button:hover:not(:disabled) { background: #533483; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }

  .btn-danger {
    background: #5c1a1a;
    border-color: #8b2020;
  }
  .btn-danger:hover:not(:disabled) { background: #8b2020; }

  .btn-download {
    background: #1a4a1a;
    border-color: #2d7a2d;
  }
  .btn-download:hover { background: #2d7a2d; }

  /* Info panel */
  .info-card {
    background: #16213e;
    border: 1px solid #0f3460;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
  }

  .info-card h2 {
    font-size: 1rem;
    color: #e94560;
    margin-bottom: 10px;
    border-bottom: 1px solid #0f3460;
    padding-bottom: 8px;
  }

  .meta-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 6px 12px;
    font-size: 0.9rem;
  }

  .meta-label {
    color: #888;
    font-weight: 500;
  }

  .meta-value {
    color: #e0e0e0;
    word-break: break-word;
  }

  .description-text {
    font-size: 0.9rem;
    line-height: 1.5;
    color: #ccc;
    white-space: pre-wrap;
  }

  .snapshot-preview {
    width: 100%;
    border-radius: 6px;
    margin-top: 8px;
    cursor: pointer;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .empty-state h2 {
    font-size: 1.3rem;
    color: #888;
    margin-bottom: 10px;
  }

  /* Loading */
  .loading {
    text-align: center;
    padding: 40px;
    color: #888;
  }

  /* Responsive: tablet */
  @media (max-width: 960px) {
    .main {
      flex-direction: column;
    }
    .info-section {
      width: 100%;
    }
  }

  /* Responsive: mobile */
  @media (max-width: 600px) {
    .header {
      padding: 10px 12px;
    }
    .header h1 {
      font-size: 0.95rem;
    }
    .main {
      padding: 12px;
      gap: 12px;
    }
    button {
      padding: 6px 10px;
      font-size: 0.8rem;
    }
    .info-section {
      width: 100%;
    }
  }
</style>
</head>
<body>

<div class="header">
  <h1>Frigate Event Viewer</h1>
  <div class="header-controls">
    <select id="cameraSelect">
      <option value="">All Cameras</option>
    </select>
  </div>
</div>

<div id="mainContent" class="main">
  <div class="loading">Loading events...</div>
</div>

<script>
(function() {
  'use strict';

  let events = [];
  let currentIndex = 0;

  const cameraSelect = document.getElementById('cameraSelect');
  const mainContent = document.getElementById('mainContent');

  // --- API ---
  async function fetchCameras() {
    try {
      const resp = await fetch('/cameras');
      const data = await resp.json();
      data.cameras.forEach(cam => {
        const opt = document.createElement('option');
        opt.value = cam;
        opt.textContent = cam.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        cameraSelect.appendChild(opt);
      });
    } catch (e) {
      console.error('Failed to fetch cameras:', e);
    }
  }

  async function fetchEvents(camera) {
    try {
      const url = camera ? `/events/${encodeURIComponent(camera)}` : '/events';
      const resp = await fetch(url);
      const data = await resp.json();
      events = data.events || [];
      currentIndex = 0;
      render();
    } catch (e) {
      console.error('Failed to fetch events:', e);
      mainContent.innerHTML = '<div class="empty-state"><h2>Error loading events</h2><p>Could not connect to the API.</p></div>';
    }
  }

  async function deleteEvent(camera, subdir) {
    if (!confirm('Delete this event? This cannot be undone.')) return;
    try {
      const resp = await fetch(`/delete/${camera}/${subdir}`, { method: 'POST' });
      if (resp.ok) {
        events.splice(currentIndex, 1);
        if (currentIndex >= events.length) currentIndex = Math.max(0, events.length - 1);
        render();
      } else {
        alert('Failed to delete event.');
      }
    } catch (e) {
      alert('Error deleting event: ' + e.message);
    }
  }

  // --- Render ---
  function render() {
    if (events.length === 0) {
      mainContent.innerHTML = `
        <div class="empty-state">
          <h2>No Events Found</h2>
          <p>No security events recorded${cameraSelect.value ? ' for this camera' : ''}.</p>
        </div>`;
      return;
    }

    const ev = events[currentIndex];
    const ts = ev.timestamp ? new Date(parseInt(ev.timestamp) * 1000) : null;
    const timeStr = ts ? ts.toLocaleString() : 'Unknown';
    const title = ev.title || ev.label.replace(/\b\w/g, c => c.toUpperCase()) + ' Detected';
    const description = ev.description || ev.summary || 'No description available.';
    const cameraDisplay = ev.camera.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    const labelDisplay = (ev.label || 'unknown').replace(/\b\w/g, c => c.toUpperCase());

    // Build the subdir for delete (timestamp_eventid)
    const subdir = ev.hosted_clip.split('/').slice(-2, -1)[0]; // e.g. "1234567890_eventid"

    mainContent.innerHTML = `
      <div class="video-section">
        <div class="video-container">
          ${ev.has_clip
            ? `<video id="videoPlayer" controls preload="metadata"
                 poster="${ev.has_snapshot ? ev.hosted_snapshot : ''}"
                 src="${ev.hosted_clip}">
                 Your browser does not support the video tag.
               </video>`
            : ev.has_snapshot
              ? `<img src="${ev.hosted_snapshot}" style="width:100%;display:block;border-radius:8px;" alt="Snapshot">`
              : `<div class="no-video">No media available</div>`
          }
        </div>
        <div class="nav-bar">
          <div class="nav-buttons">
            <button id="btnNewer" ${currentIndex <= 0 ? 'disabled' : ''}>&#9664; Newer</button>
            <button id="btnOlder" ${currentIndex >= events.length - 1 ? 'disabled' : ''}>Older &#9654;</button>
          </div>
          <span class="event-counter">${currentIndex + 1} / ${events.length}</span>
          <div class="nav-buttons">
            ${ev.has_clip ? `<a href="${ev.hosted_clip}" download style="text-decoration:none;"><button class="btn-download">Download</button></a>` : ''}
            <button class="btn-danger" id="btnDelete">Delete</button>
          </div>
        </div>
      </div>
      <div class="info-section">
        <div class="info-card">
          <h2>AI Analysis</h2>
          ${ev.title ? `<p style="font-weight:600;margin-bottom:8px;color:#e0e0e0;">${escapeHtml(ev.title)}</p>` : ''}
          <p class="description-text">${escapeHtml(description)}</p>
        </div>
        <div class="info-card">
          <h2>Event Details</h2>
          <div class="meta-grid">
            <span class="meta-label">Camera</span>
            <span class="meta-value">${escapeHtml(cameraDisplay)}</span>
            <span class="meta-label">Label</span>
            <span class="meta-value">${escapeHtml(labelDisplay)}</span>
            <span class="meta-label">Time</span>
            <span class="meta-value">${escapeHtml(timeStr)}</span>
            <span class="meta-label">Event ID</span>
            <span class="meta-value" style="font-size:0.8rem;color:#888;">${escapeHtml(ev.event_id)}</span>
            ${ev.severity ? `<span class="meta-label">Severity</span><span class="meta-value">${escapeHtml(ev.severity)}</span>` : ''}
          </div>
        </div>
        ${ev.has_snapshot ? `
        <div class="info-card">
          <h2>Snapshot</h2>
          <img class="snapshot-preview" src="${ev.hosted_snapshot}" alt="Snapshot"
               onclick="document.getElementById('videoPlayer')&&document.getElementById('videoPlayer').play()">
        </div>` : ''}
      </div>`;

    // Bind navigation
    const btnNewer = document.getElementById('btnNewer');
    const btnOlder = document.getElementById('btnOlder');
    const btnDelete = document.getElementById('btnDelete');

    if (btnNewer) btnNewer.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; render(); } });
    if (btnOlder) btnOlder.addEventListener('click', () => { if (currentIndex < events.length - 1) { currentIndex++; render(); } });
    if (btnDelete) btnDelete.addEventListener('click', () => deleteEvent(ev.camera, subdir));
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // --- Init ---
  cameraSelect.addEventListener('change', () => fetchEvents(cameraSelect.value));
  fetchCameras();
  fetchEvents('');
})();
</script>
</body>
</html>
