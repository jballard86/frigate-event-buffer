# Folder Structure and API Endpoints

This document breaks down the primary storage folders (Events and Daily Reports) created and managed by the Frigate Event Buffer, including naming conventions, file contents, and how to access them externally via the REST API.

---

## 1. Folder Breakdown

All folders are created within the configured `STORAGE_PATH` (e.g., `/media/frigate/buffer`).

### Event Folders

The system organizes events primarily into a Consolidated Event (CE) structure, grouping multiple cameras into a single event timeline.

#### Consolidated Events (`events/`)
This is the primary location for multi-camera events.
* **Path:** `storage_path/events/<ce_id>/`
* **Naming Convention (`ce_id`):** `{timestamp}_{id}` (e.g., `1709283920_1709283920.12345-abcd`). Manual test runs use `test1`, `test2`, etc.

**Subfolders within a CE:**
* `<camera_name>/` (e.g., `events/<ce_id>/front_door/`): Contains media and metadata specific to a camera involved in the consolidated event.

**Files within `events/<ce_id>/<camera_name>/`:**
* `{clip_basename}.mp4`: The downloaded video clip from Frigate.
* `snapshot.jpg`: The full-resolution snapshot downloaded from Frigate.
* `snapshot_cropped.jpg`: A cropped version of the snapshot focusing on the detection, generated by the Quick Title service using `crop_utils`.
* `metadata.json`: Machine-readable metadata specific to this camera's involvement.

**Files within `events/<ce_id>/` (CE Root):**
* `summary.txt`: A plain-text summary of the event (ID, Label, Timestamp, GenAI Title/Description, Threat Level).
* `metadata.json`: Machine-readable metadata for the overall consolidated event.
* `review_summary.md`: A detailed Markdown summary of the event fetched from Frigate GenAI (if applicable).
* `notification_timeline.json`: The base timeline of the event.
* `notification_timeline_append.jsonl`: Append-only log of timeline entries.
* `ai_analysis_debug.zip`: An archive containing extracted frames and the raw AI analysis result.
* `analysis_result.json`: The raw JSON output from the Gemini proxy analysis.
* `notification.gif`: A generated GIF animation from the video clip.
* `{ce_id}_summary.mp4`: A compiled summary video stitched from multiple cameras (20fps, H264).
* `ai_frame_analysis/` (Directory):
  * `manifest.json`: List of frames sent to the AI proxy.
  * `frames/frame_{seq}_{camera}.jpg`: The individual frames extracted via GPU and sent to AI.

#### Saved Events (`saved/`)
When a user "keeps" an event, it is moved here to prevent it from being deleted by the automated retention cleanup.
* **Path:** `storage_path/saved/events/<ce_id>/`
* The internal structure of the saved event folder remains absolutely identical to its original location.

### Daily Reports (`daily_reports/`)

This folder stores aggregated daily security reports generated by the AI from the day's `analysis_result.json` files.
* **Path:** `storage_path/daily_reports/`

**Files within `daily_reports/`:**
* `{YYYY-MM-DD}_report.md` (e.g., `2026-03-01_report.md`): The generated Markdown report for a specific day.
* `aggregate_{YYYY-MM-DD}.jsonl`: A temporary file where event analyses are appended throughout the day. This file is read when generating the report and deleted upon successful report generation.

---

## 2. External API Endpoints

The Flask web application serves these files and data externally. These endpoints can be used by Home Assistant, the mobile app, or other integrations.

### Event Media & Files

**Base Endpoint:** `GET /files/<path:filename>`
**Description:** Serves any file located strictly within the `STORAGE_PATH`. Path traversal is prevented via `resolve_under_storage()`.

**Common Examples:**
* **Video Clip:** `GET /files/events/{ce_id}/{camera_name}/{clip_basename}.mp4`
* **Compiled Summary Video:** `GET /files/events/{ce_id}/{ce_id}_summary.mp4`
* **Full Snapshot:** `GET /files/events/{ce_id}/{camera_name}/snapshot.jpg`
* **Cropped Snapshot:** `GET /files/events/{ce_id}/{camera_name}/snapshot_cropped.jpg`
* **GIF Animation:** `GET /files/events/{ce_id}/notification.gif`
* **Saved Video Clip:** `GET /files/saved/events/{ce_id}/{camera_name}/{clip_basename}.mp4`

### Event Timelines

**Endpoint:** `GET /api/events/events/{ce_id}/timeline/download`
**Description:** Returns the complete event timeline as a downloaded JSON file. It internally merges `notification_timeline.json` with the `notification_timeline_append.jsonl` append log to provide the full picture.

### Daily Reports

The Daily Review API provides structured access to the Markdown reports.

* **Endpoint:** `GET /api/daily-review/current`
  **Description:** Returns the report for today (if already generated) in JSON format: `{"summary": "<markdown content>"}`. Returns 404 if not yet generated.

* **Endpoint:** `GET /api/daily-review/{YYYY-MM-DD}`
  **Description:** Returns the report for a specific date in JSON format. Example: `GET /api/daily-review/2026-03-01`.

* **Endpoint:** `GET /api/daily-review/dates`
  **Description:** Returns a JSON list of dates (`["YYYY-MM-DD", ...]`) that have available reports.

* **Direct File Access:**
  If you need the raw markdown file directly without the JSON wrapper, you can use the files endpoint:
  `GET /files/daily_reports/{YYYY-MM-DD}_report.md`
