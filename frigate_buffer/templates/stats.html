<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stats - Frigate Event Buffer</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    min-height: 100vh;
  }

  .header {
    background: #16213e;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #0f3460;
    flex-wrap: wrap;
    gap: 8px;
  }

  .header h1 {
    font-size: 1.1rem;
    color: #e94560;
    white-space: nowrap;
  }

  .header-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  select, button {
    background: #0f3460;
    color: #e0e0e0;
    border: 1px solid #533483;
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 0.85rem;
    cursor: pointer;
  }

  select:focus, button:focus { outline: 2px solid #e94560; }

  button:hover { background: #533483; }

  a { text-decoration: none; color: inherit; }

  .main {
    max-width: 800px;
    margin: 0 auto;
    padding: 16px;
  }

  .stats-panel { margin-top: 16px; text-align: center; }
  .stats-panel .info-card {
    margin-top: 12px;
    padding: 16px;
    background: #16213e;
    border: 1px solid #0f3460;
    border-radius: 8px;
    text-align: center;
  }
  .stats-panel .info-card:first-of-type { margin-top: 0; }
  .stats-panel .info-card h2 { text-align: center; color: #e94560; font-size: 1rem; margin-bottom: 12px; }
  .stats-panel .stats-row {
    display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
    gap: 16px 24px; margin: 8px 0; font-size: 0.9rem; text-align: center;
  }
  .stats-panel .stats-item { display: flex; gap: 6px; justify-content: center; }
  .stats-panel .stats-item strong { color: #e94560; min-width: 4ch; }
  .stats-panel .errors-list {
    max-height: 200px; overflow-y: auto; font-size: 0.8rem; font-family: monospace;
    background: #0f3460; border-radius: 4px; padding: 8px; margin: 8px auto;
    text-align: left; max-width: 100%;
  }
  .stats-panel .errors-list .err-item { margin: 6px 0; padding: 4px 0; border-bottom: 1px solid #1a1a2e; word-break: break-word; }
  .stats-panel .errors-list .err-ts { color: #888; margin-right: 8px; }
  .stats-panel .errors-footer { font-size: 0.8rem; color: #666; margin-top: 8px; text-align: center; }
  .stats-panel .camera-table {
    margin: 0 auto; border-collapse: collapse; font-size: 0.9rem;
  }
  .stats-panel .camera-table td { padding: 6px 16px; border-bottom: 1px solid #0f3460; text-align: center; }
  .stats-panel .camera-table .meta-label { padding-right: 12px; text-align: center; }
  .stats-panel .meta-grid {
    display: grid; grid-template-columns: auto auto;
    justify-content: center; justify-items: start; gap: 4px 16px;
    margin: 8px auto; text-align: left; max-width: fit-content;
  }

  .loading {
    text-align: center;
    padding: 40px;
    color: #888;
  }
</style>
</head>
<body data-stats-refresh-seconds="{{ stats_refresh_seconds|default(60)|int }}">

<div class="header">
  <h1>Stats</h1>
  <div class="header-controls">
    <a href="/player"><button>Back to Events</button></a>
    <button id="btnRefreshStats">Refresh Stats</button>
  </div>
</div>

<div class="main">
  <div id="statsContainer" class="loading">Loading stats...</div>
</div>

<script>
(function() {
  'use strict';

  const statsContainer = document.getElementById('statsContainer');
  const btnRefreshStats = document.getElementById('btnRefreshStats');
  let refreshTimer = null;

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function getRefreshSeconds() {
    const val = document.body.dataset.statsRefreshSeconds || '60';
    return parseInt(val, 10) || 60;
  }

  async function fetchStats() {
    try {
      const resp = await fetch('/stats');
      const data = await resp.json();
      renderStats(data);
    } catch (e) {
      console.error('Failed to fetch stats:', e);
      statsContainer.innerHTML = '<p style="color:#e94560;">Failed to load stats.</p>';
    }
  }

  function renderStats(data) {
    const c = data.events || {};
    const s = data.storage || {};
    const errs = data.errors || [];
    const lc = data.last_cleanup;
    const mr = data.most_recent;
    const sys = data.system || {};
    const ha = data.ha_helpers || null;

    const fmtStorage = (cam) => {
      if (!cam) return '-';
      if (cam.gb != null) return cam.gb + ' GB';
      if (cam.mb != null) return cam.mb + ' MB';
      return '-';
    };
    const totalStorage = s.total_gb != null ? s.total_gb + ' GB' : (s.total_mb != null ? s.total_mb + ' MB' : '-');

    const byCam = c.by_camera || {};
    const camRows = Object.entries(byCam).map(([name, count]) =>
      `<tr><td class="meta-label">${escapeHtml(name.replace(/_/g, ' '))}</td><td>${count}</td></tr>`
    ).join('');

    const storageRows = Object.entries(s.by_camera || {}).map(([name, val]) =>
      `<tr><td class="meta-label">${escapeHtml(name.replace(/_/g, ' '))}</td><td>${fmtStorage(val)}</td></tr>`
    ).join('');

    const bd = s.breakdown || {};
    const errItems = errs.slice(0, 10).map(e =>
      `<div class="err-item"><span class="err-ts">${escapeHtml(e.ts || '')}</span>${escapeHtml((e.message || '').substring(0, 300))}</div>`
    ).join('');

    const uptime = sys.uptime_seconds != null ? Math.floor(sys.uptime_seconds / 60) + ' min' : '-';

    let apiUsageCard = '';
    if (ha && (ha.gemini_month_cost != null || ha.gemini_month_tokens != null)) {
      const costStr = ha.gemini_month_cost != null ? '$' + Number(ha.gemini_month_cost).toFixed(5) : '-';
      const tokensStr = ha.gemini_month_tokens != null ? (ha.gemini_month_tokens).toLocaleString() : '-';
      apiUsageCard = `
        <div class="info-card">
          <h2>API Usage</h2>
          <div class="stats-row">
            <span class="stats-item"><strong>Month to Date API cost:</strong> ${costStr}</span>
            <span class="stats-item"><strong>Month to Date Token Usage:</strong> ${tokensStr}</span>
          </div>
        </div>`;
    }

    const html = `
      <div class="stats-panel">
        ${apiUsageCard}
        <div class="info-card">
          <h2>Event Counts</h2>
          <div class="stats-row">
            <span class="stats-item"><strong>Today:</strong> ${c.today ?? 0}</span>
            <span class="stats-item"><strong>This Week:</strong> ${c.this_week ?? 0}</span>
            <span class="stats-item"><strong>This Month:</strong> ${c.this_month ?? 0}</span>
          </div>
          <div class="stats-row">
            <span class="stats-item"><strong>Reviewed:</strong> ${c.total_reviewed ?? 0}</span>
            <span class="stats-item"><strong>Unreviewed:</strong> ${c.total_unreviewed ?? 0}</span>
          </div>
        </div>
        <div class="info-card">
          <h2>Events by Camera</h2>
          <table class="camera-table"><tbody>${camRows || '<tr><td>No cameras</td></tr>'}</tbody></table>
        </div>
        <div class="info-card">
          <h2>Storage</h2>
          <div class="stats-row">
            <span class="stats-item"><strong>Total:</strong> ${totalStorage}</span>
          </div>
          <div class="stats-row" style="margin-top:8px;">
            <span class="meta-label">Clips:</span> ${bd.clips_mb ?? 0} MB |
            <span class="meta-label">Snapshots:</span> ${bd.snapshots_mb ?? 0} MB |
            <span class="meta-label">Descriptions:</span> ${bd.descriptions_mb ?? 0} MB
          </div>
          ${storageRows ? `<table class="camera-table" style="margin-top:8px;"><tbody>${storageRows}</tbody></table>` : ''}
        </div>
        <div class="info-card">
          <h2>Recent Activity</h2>
          <div class="stats-row">
            ${lc ? `<span class="stats-item"><strong>Last cleanup:</strong> ${escapeHtml(lc.at)} (deleted ${lc.deleted})</span>` : '<span class="stats-item">No cleanup recorded yet</span>'}
          </div>
          ${mr ? `<div class="stats-row"><a href="${escapeHtml(mr.url)}" style="color:#e94560;">View most recent notification</a></div>` : ''}
        </div>
        <div class="info-card">
          <h2>Errors</h2>
          ${errItems ? `<div class="errors-list">${errItems}</div><p class="errors-footer">See container logs for full error history.</p>` : '<p>No recent errors.</p>'}
        </div>
        <div class="info-card">
          <h2>System</h2>
          <div class="meta-grid">
            <span class="meta-label">Uptime</span>
            <span class="meta-value">${uptime}</span>
            <span class="meta-label">MQTT</span>
            <span class="meta-value">${sys.mqtt_connected ? 'Connected' : 'Disconnected'}</span>
            <span class="meta-label">Active events</span>
            <span class="meta-value">${sys.active_events ?? 0}</span>
            <span class="meta-label">Retention</span>
            <span class="meta-value">${sys.retention_days ?? '-'} days</span>
            <span class="meta-label">Cleanup interval</span>
            <span class="meta-value">${sys.cleanup_interval_hours ?? '-'} hrs</span>
            ${sys.storage_path ? `<span class="meta-label">Storage path</span><span class="meta-value" style="font-size:0.8rem;">${escapeHtml(sys.storage_path)}</span>` : ''}
          </div>
        </div>
      </div>`;

    statsContainer.innerHTML = html;
  }

  function startAutoRefresh() {
    if (refreshTimer) clearInterval(refreshTimer);
    const intervalMs = getRefreshSeconds() * 1000;
    refreshTimer = setInterval(() => fetchStats(), intervalMs);
  }

  btnRefreshStats.addEventListener('click', () => fetchStats());

  (async function init() {
    await fetchStats();
    startAutoRefresh();
  })();
})();
</script>
</body>
</html>
