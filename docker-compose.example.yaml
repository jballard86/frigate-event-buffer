version: '3.8'

services:
  frigate-buffer:
    # --- Build Configuration ---
    # Option 1 (default): Build from the local directory.
    # This is used when you have cloned the repository to your machine.
    build: .

    # Option 2: Build from private GitHub using token pull (Dockge/Portainer).
    # Comment out "build: ." above, uncomment the block below, and replace
    # placeholders with your GitHub username and PAT (repo scope).
    # build:
    #   context: https://YOUR_GITHUB_USERNAME:YOUR_GITHUB_PAT@github.com/jballard86/frigate-event-buffer.git#main

    container_name: frigate_buffer
    restart: unless-stopped
    ports:
      # Exposes the application's web server on port 5055.
      # Format: <host_port>:<container_port>
      - "5055:5055"
    volumes:
      # --- IMPORTANT: Update these paths to match your host system ---
      # Maps the container's storage folder to a directory on your host.
      # This is where clips, snapshots, and summaries will be saved.
      - /path/to/your/appdata/frigate_buffer:/app/storage

      # (Optional) Mount a config.yaml file for advanced camera/label filtering.
      # Environment variables below will override settings in this file.
      - /path/to/your/appdata/frigate_buffer/config.yaml:/app/config.yaml:ro

      # (Optional) Map timezone so container logs match your local time.
      - /etc/localtime:/etc/localtime:ro
    environment:
      # --- REQUIRED ---
      # The IP/hostname where this container is reachable (used in notification image/video URLs).
      - BUFFER_IP=YOUR_BUFFER_IP
      # Your Frigate server URL.
      - FRIGATE_URL=http://YOUR_FRIGATE_IP:5000
      # Your MQTT Broker IP/hostname.
      - MQTT_BROKER=YOUR_MQTT_BROKER_IP

      # --- OPTIONAL (these will override settings in config.yaml) ---
      - MQTT_PORT=1883
      - RETENTION_DAYS=3
      - LOG_LEVEL=INFO
      # GPU: NVDEC/NVENC (requires NVIDIA Container Toolkit and deploy.reservations below)
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5055/status"]
      interval: 60s
      timeout: 10s
      retries: 3
